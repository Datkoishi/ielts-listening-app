<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>IELTS Listening Test Creator</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="../teacher/css/styles.css">
<!-- Thêm CSS mới -->
<link rel="stylesheet" href="../teacher/css/api-integration.css">
<!-- Thêm file debug.js đầu tiên để sửa lỗi -->
<script src="../teacher/js/debug.js"></script>
<!-- Thêm file global-variables.js để khởi tạo các biến toàn cục -->
<script src="../teacher/js/global-variables.js"></script>
</head>
<body>
<div class="selection-page" id="selectionPage">
    <h1><i class="fas fa-headphones"></i> Công cụ tạo bài kiểm tra IELTS Listening</h1>
    <p>Chọn loại câu hỏi để đưa vào bài kiểm tra của bạn:</p>
    <div class="question-types" id="questionTypes">
        <div class="question-type">
            <input type="checkbox" id="oneAnswer" value="Một đáp án">
            <label for="oneAnswer"><i class="fas fa-check-circle"></i> Một đáp án</label>
        </div>
        <div class="question-type">
            <input type="checkbox" id="multipleAnswers" value="Nhiều đáp án">
            <label for="multipleAnswers"><i class="fas fa-check-double"></i> Nhiều đáp án</label>
        </div>
        <div class="question-type">
            <input type="checkbox" id="matching" value="Ghép nối">
            <label for="matching"><i class="fas fa-link"></i> Ghép nối</label>
        </div>
        <div class="question-type">
            <input type="checkbox" id="labelling" value="Ghi nhãn Bản đồ/Sơ đồ">
            <label for="labelling"><i class="fas fa-map-marker-alt"></i> Ghi nhãn Bản đồ/Sơ đồ</label>
        </div>
        <div class="question-type">
            <input type="checkbox" id="noteCompletion" value="Hoàn thành ghi chú">
            <label for="noteCompletion"><i class="fas fa-sticky-note"></i> Hoàn thành ghi chú</label>
        </div>
        <div class="question-type">
            <input type="checkbox" id="formCompletion" value="Hoàn thành bảng/biểu mẫu">
            <label for="formCompletion"><i class="fas fa-table"></i> Hoàn thành bảng/biểu mẫu</label>
        </div>
        <div class="question-type">
            <input type="checkbox" id="flowchartCompletion" value="Hoàn thành lưu đồ">
            <label for="flowchartCompletion"><i class="fas fa-project-diagram"></i> Hoàn thành lưu đồ</label>
        </div>
    </div>
    <button id="startTestBtn"><i class="fas fa-play"></i> Tạo bài kiểm tra</button>
</div>

<div class="test-creation-page hidden" id="testCreationPage">
    <h1><i class="fas fa-pencil-alt"></i> Bài kiểm tra IELTS Listening</h1>
    <div class="test-metadata-form">
    <div class="form-group">
      <label for="testTitle">Tiêu đề bài kiểm tra (Tiếng Anh):</label>
      <input type="text" id="testTitle" required placeholder="Nhập tiêu đề bài kiểm tra bằng tiếng Anh">
    </div>
    <div class="form-group">
      <label for="testVietnameseName">Tên bộ câu hỏi (Tiếng Việt):</label>
      <input type="text" id="testVietnameseName" placeholder="Nhập tên bộ câu hỏi bằng tiếng Việt">
    </div>
    <div class="form-group">
      <label for="testDescription">Mô tả (không bắt buộc):</label>
      <textarea id="testDescription" rows="2" placeholder="Nhập mô tả cho bài kiểm tra"></textarea>
    </div>
  </div>
    <div id="testContent"></div>
    <div class="nav-buttons">
        <button id="previousPartBtn"><i class="fas fa-arrow-left"></i> Phần trước</button>
        <button id="nextPartBtn">Phần tiếp theo <i class="fas fa-arrow-right"></i></button>
    </div>
    <div class="test-actions">
        <button id="saveTestBtn"><i class="fas fa-save"></i> Lưu bài kiểm tra</button>
        <button id="previewTestBtn"><i class="fas fa-eye"></i> Xem trước</button>
        <button id="exportTestBtn"><i class="fas fa-file-export"></i> Xuất</button>
        <button id="importTestBtn"><i class="fas fa-file-import"></i> Nhập</button>
        <button id="showTestListBtn"><i class="fas fa-list"></i> Danh sách</button>
        <button id="createNewTestBtn"><i class="fas fa-file"></i> Tạo mới</button>
        <!-- Thêm nút cấu hình server vào menu -->
        <button id="serverConfigBtn" class="server-config-button">
          <i class="fas fa-cog"></i> Cấu hình Server
        </button>
        <!-- Thêm nút kiểm tra và sửa lỗi vào menu -->
        <button id="troubleshooterBtn" class="troubleshooter-button">
          <i class="fas fa-wrench"></i> Kiểm tra và sửa lỗi
        </button>
    </div>
</div>

<!-- Thêm div để hiển thị trạng thái API -->
<div id="apiStatus" class="api-status-container"></div>

<!-- Thêm container cho cấu hình server -->
<div id="serverConfigContainer"></div>

<!-- Thêm container cho công cụ kiểm tra và sửa lỗi -->
<div id="troubleshooterContainer"></div>

<!-- Thêm container cho trạng thái server -->
<div id="serverStatusContainer" class="server-status-container"></div>

<!-- Tải các file JavaScript cần thiết trước -->
<script src="../teacher/js/api-utils.js"></script>
<script src="../teacher/js/server-config.js"></script>
<script src="../teacher/js/troubleshooter.js"></script>
<script src="../teacher/js/audio-validator.js"></script>
<script src="../teacher/js/server-status.js"></script>

<!-- Sau đó tải các file JavaScript chính -->
<script src="../teacher/js/form-handlers.js"></script>
<script src="../teacher/js/index.js"></script>
<script src="../teacher/js/test-management.js"></script>
<script src="../teacher/js/client-integration.js"></script>
<script src="../teacher/js/main.js"></script>
<script src="../teacher/js/question-types.js"></script>

<!-- Thêm script để khởi tạo các tính năng mới -->
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Kiểm tra và sửa các hàm bị thiếu
    if (typeof fixShowTroubleshooter === 'function') {
      fixShowTroubleshooter();
    }
    if (typeof fixShowServerConfigUI === 'function') {
      fixShowServerConfigUI();
    }
    
    // Hiển thị trạng thái API
    if (typeof displayApiStatus === 'function') {
      displayApiStatus('apiStatus');
    }
    
    // Bắt đầu kiểm tra trạng thái server
    if (typeof startServerStatusCheck === 'function') {
      startServerStatusCheck('serverStatusContainer');
    }
    
    // Kiểm tra và đồng bộ hóa dữ liệu offline khi tải trang
    if (navigator.onLine && typeof syncOfflineTests === 'function') {
      setTimeout(() => {
        syncOfflineTests();
      }, 3000);
    }
    
    // Thêm sự kiện lắng nghe kết nối internet
    window.addEventListener('online', () => {
      if (typeof displayApiStatus === 'function') {
        displayApiStatus('apiStatus');
      }
      if (typeof syncOfflineTests === 'function') {
        syncOfflineTests();
      }
    });
    
    window.addEventListener('offline', () => {
      if (typeof displayApiStatus === 'function') {
        displayApiStatus('apiStatus');
      }
    });

    // Thêm sự kiện cho các nút
    const serverConfigBtn = document.getElementById('serverConfigBtn');
    if (serverConfigBtn) {
      serverConfigBtn.addEventListener('click', function() {
        console.log('Nút cấu hình server được nhấp');
        if (typeof window.showServerConfigUI === 'function') {
          window.showServerConfigUI('serverConfigContainer');
        } else {
          console.error('Hàm showServerConfigUI chưa được định nghĩa');
          alert('Chức năng cấu hình server chưa được cài đặt đầy đủ.');
        }
      });
    }

    const troubleshooterBtn = document.getElementById('troubleshooterBtn');
    if (troubleshooterBtn) {
      troubleshooterBtn.addEventListener('click', function() {
        console.log('Nút kiểm tra và sửa lỗi được nhấp');
        if (typeof window.showTroubleshooter === 'function') {
          window.showTroubleshooter('troubleshooterContainer');
        } else {
          console.error('Hàm showTroubleshooter chưa được định nghĩa');
          alert('Chức năng kiểm tra và sửa lỗi chưa được cài đặt đầy đủ.');
        }
      });
    }
    
    // Kiểm tra các hàm quan trọng
    console.log('Kiểm tra các hàm quan trọng:');
    console.log('showTroubleshooter:', typeof window.showTroubleshooter === 'function' ? 'Đã định nghĩa' : 'Chưa định nghĩa');
    console.log('showServerConfigUI:', typeof window.showServerConfigUI === 'function' ? 'Đã định nghĩa' : 'Chưa định nghĩa');
    
    // Kiểm tra lại các biến toàn cục
    console.log('=== KIỂM TRA LẠI CÁC BIẾN TOÀN CỤC ===');
    console.log('API_URL:', typeof window.API_URL !== 'undefined' ? '✅ Đã định nghĩa' : '❌ Chưa định nghĩa');
    console.log('test:', typeof window.test !== 'undefined' ? '✅ Đã định nghĩa' : '❌ Chưa định nghĩa');
    console.log('currentPart:', typeof window.currentPart !== 'undefined' ? '✅ Đã định nghĩa' : '❌ Chưa định nghĩa');
    console.log('selectedTypes:', typeof window.selectedTypes !== 'undefined' ? '✅ Đã định nghĩa' : '❌ Chưa định nghĩa');
    console.log('audioFile:', typeof window.audioFile !== 'undefined' ? '✅ Đã định nghĩa' : '❌ Chưa định nghĩa');
  });
</script>
</body>
</html>
