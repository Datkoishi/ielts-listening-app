<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Listening Test Creator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Times New Roman', Times, serif;
            line-height: 1.6;
            color: #333;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f9f9f9;
        }
        h1, h2, h3 {
            color: #003366;
        }
        .selection-page, .test-creation-page {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .question-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
        }
        .question-type {
            background-color: #e6f2ff;
            padding: 10px;
            border-radius: 4px;
            display: flex;
            align-items: center;
        }
        .question-type input[type="checkbox"] {
            margin-right: 10px;
        }
        button {
            background-color: #003366;
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-top: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button:hover {
            background-color: #004080;
        }
        button i {
            margin-right: 5px;
        }
        .part {
            background-color: #fff;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
            border: 1px solid #ccc;
        }
        .question {
            background-color: #f9f9f9;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            position: relative;
        }
        .question h3 {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .question h3 i {
            margin-right: 10px;
            color: #003366;
        }
        input[type="text"], textarea, select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: 'Times New Roman', Times, serif;
        }
        .hidden {
            display: none;
        }
        .nav-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .question-count {
            font-weight: bold;
            margin-bottom: 10px;
            color: #003366;
        }
        .part-header {
            background-color: #003366;
            color: #fff;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .part-header h2 {
            margin: 0;
            color: #fff;
        }
        .delete-question {
            position: absolute;
            top: 10px;
            right: 10px;
            background-color: #ff4d4d;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
        }
        .delete-question:hover {
            background-color: #ff3333;
        }
        /* Styles for Plan/Map/Diagram labelling */
        .t1-ielts-creator {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
        }
        .t1-form-section, .t1-question-display, .t1-instructions-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        .t1-form-group {
            margin-bottom: 15px;
        }
        .t1-ielts-creator label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .t1-ielts-creator input[type="text"],
        .t1-ielts-creator input[type="number"],
        .t1-ielts-creator input[type="file"],
        .t1-ielts-creator select,
        .t1-ielts-creator textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        .t1-question-container {
            margin-top: 20px;
        }
        .t1-diagram-container {
            margin-bottom: 20px;
        }
        .t1-diagram-container img {
            max-width: 100%;
            height: auto;
        }
        .t1-answers-container {
            width: 100%;
        }
        .t1-answer-grid {
            width: 100%;
            border-collapse: collapse;
        }
        .t1-answer-grid th,
        .t1-answer-grid td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }
        .t1-answer-grid th {
            background-color: #f0f0f0;
            font-weight: normal;
        }
        .t1-answer-input {
            width: 40px;
            height: 30px;
            text-align: center;
            font-size: 16px;
            border: 1px solid #ccc;
        }
        .t1-instructions {
            margin-bottom: 15px;
        }
        .t1-instructions-list {
            padding-left: 20px;
        }
        .t1-instructions-list li {
            margin-bottom: 10px;
        }
        .t1-save-button {
            margin-top: 20px;
        }
        .t1-notification {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }
        .t1-notification-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .t1-notification-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .t3-question-creator {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .t3-question-creator h1, .t3-question-creator h2, .t3-question-creator h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .t3-question-creator .t3-form-group {
            margin-bottom: 20px;
        }

        .t3-question-creator label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .t3-question-creator input[type="text"],
        .t3-question-creator input[type="number"],
        .t3-question-creator textarea,
        .t3-question-creator select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .t3-question-creator textarea {
            height: 100px;
        }

        .t3-question-creator button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .t3-question-creator button:hover {
            background-color: #45a049;
        }

        .t3-question-creator .t3-preview {
            margin-top: 40px;
            border-top: 2px solid #ccc;
            padding-top: 20px;
        }

        .t3-question-creator .t3-matching-section {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .t3-question-creator .t3-column-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #ccc;
        }

        .t3-question-creator .t3-matching-content,
        .t3-question-creator .t3-responsibilities-content {
            display: grid;
            gap: 12px;
        }

        .t3-question-creator .t3-person-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .t3-question-creator .t3-person-name {
            font-size: 14px;
            color: #333;
            white-space: nowrap;
        }

        .t3-question-creator .t3-answer-box {
            height: 30px;
            border: 1px solid #999;
            border-radius: 4px;
            background-color: #fff;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 14px;
            min-width: 150px;
        }

        .t3-question-creator .t3-answer-box.t3-dragover {
            background-color: #e8e8e8;
            border: 2px dashed #666;
        }

        .t3-question-creator .t3-responsibility {
            font-size: 14px;
            color: #333;
            background-color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            display: inline-block;
            cursor: move;
            user-select: none;
            transition: all 0.2s ease;
        }

        .t3-question-creator .t3-responsibility.t3-dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .t3-question-creator .t3-correct-answer {
            font-size: 12px;
            color: #4CAF50;
            margin-left: 10px;
        }

        .t3-question-creator .t3-guide {
            background-color: #e7f3fe;
            border-left: 5px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
        }

        .t3-question-creator .t3-guide h3 {
            color: #2196F3;
            margin-top: 0;
        }

        .t3-question-creator .t3-guide ul {
            padding-left: 20px;
            margin-bottom: 0;
        }

        .t3-question-creator .t3-guide li {
            margin-bottom: 10px;
        }

        .t3-question-creator .t3-save-button {
            background-color: #2196F3;
        }

        .t3-question-creator .t3-save-button:hover {
            background-color: #0b7dda;
        }

        .t3-question-creator .t3-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .t3-question-creator .t3-success {
            background-color: #dff0d8;
            color: #3c763d;
        }

        .t3-question-creator .t3-error {
            background-color: #f2dede;
            color: #a94442;
        }
        .t4-listening-test-creator {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            color: #333;
        }
        .t4-listening-test-creator .t4-container {
            max-width: 800px;
            margin: 20px auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
        }
        .t4-listening-test-creator h1, .t4-listening-test-creator h2 {
            color: #333;
        }
        .t4-listening-test-creator .t4-instructions {
            background-color: #f0f8ff;
            border: 1px solid #b0d4ff;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .t4-listening-test-creator .t4-instructions h2 {
            margin-top: 0;
            color: #0066cc;
        }
        .t4-listening-test-creator .t4-instructions ol {
            padding-left: 20px;
        }
        .t4-listening-test-creator form {
            margin-bottom: 20px;
        }
        .t4-listening-test-creator label {
            display: block;
            margin-top: 10px;
        }
        .t4-listening-test-creator input[type="text"], 
        .t4-listening-test-creator textarea, 
        .t4-listening-test-creator select {
            width: 100%;
            padding: 8px;
            margin-top: 5px;
            box-sizing: border-box;
        }
        .t4-listening-test-creator button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        .t4-listening-test-creator button:hover {
            background-color: #45a049;
        }
        .t4-listening-test-creator .t4-preview {
            background: linear-gradient(to bottom, #f0f0f0, #e0e0e0);
            padding: 20px;
            border-radius: 8px;
            margin-top: 20px;
        }
        .t4-listening-test-creator .t4-preview h2 {
            font-size: 16px;
            margin-bottom: 15px;
        }
        .t4-listening-test-creator .t4-preview label {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .t4-listening-test-creator .t4-preview input[type="checkbox"] {
            margin-right: 10px;
        }
        .t4-listening-test-creator .t4-question-form {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .t4-listening-test-creator .t4-correct-answer {
            margin-left: 20px;
            color: green;
        }
        .t7-ielts-flow-chart-creator {
        font-family: Arial, sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .t7-ielts-flow-chart-creator h1, .t7-ielts-flow-chart-creator h2 {
        color: #2c3e50;
      }
      .t7-ielts-flow-chart-creator .t7-instructions {
        background-color: #e7f2fa;
        border-left: 5px solid #3498db;
        padding: 10px;
        margin-bottom: 20px;
      }
      .t7-ielts-flow-chart-creator .t7-flow-chart {
        margin-bottom: 20px;
      }
      .t7-ielts-flow-chart-creator .t7-flow-item {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 10px;
        margin-bottom: 10px;
        position: relative;
      }
      .t7-ielts-flow-chart-creator .t7-flow-item::after {
        content: '↓';
        position: absolute;
        bottom: -20px;
        left: 50%;
        font-size: 20px;
        color: #6c757d;
      }
      .t7-ielts-flow-chart-creator .t7-flow-item:last-child::after {
        display: none;
      }
      .t7-ielts-flow-chart-creator .t7-gap {
        display: inline-block;
        width: 150px;
        height: 25px;
        border: 2px dashed #ced4da;
        vertical-align: middle;
        margin: 0 5px;
      }
      .t7-ielts-flow-chart-creator .t7-options {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 20px;
      }
      .t7-ielts-flow-chart-creator .t7-option {
        background-color: #e9ecef;
        border: 1px solid #ced4da;
        padding: 5px 10px;
        cursor: move;
        user-select: none;
      }
      .t7-ielts-flow-chart-creator .t7-timer {
        text-align: right;
        font-size: 1.2em;
        font-weight: bold;
        color: #e74c3c;
        margin-bottom: 10px;
      }
      .t7-ielts-flow-chart-creator #teacherForm {
        background-color: #f8f9fa;
        padding: 20px;
        border-radius: 5px;
        margin-bottom: 20px;
      }
      .t7-ielts-flow-chart-creator #teacherForm label {
        display: block;
        margin-bottom: 5px;
      }
      .t7-ielts-flow-chart-creator #teacherForm input[type="text"],
      .t7-ielts-flow-chart-creator #teacherForm input[type="number"],
      .t7-ielts-flow-chart-creator #teacherForm textarea {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
      }
      .t7-ielts-flow-chart-creator #teacherForm button {
        background-color: #3498db;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }
      .t7-ielts-flow-chart-creator #teacherForm button:hover {
        background-color: #2980b9;
      }
      .t7-ielts-flow-chart-creator .t7-toggle-view {
        background-color: #2ecc71;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-bottom: 20px;
      }
      .t7-ielts-flow-chart-creator .t7-toggle-view:hover {
        background-color: #27ae60;
      }
      .t7-ielts-flow-chart-creator .t7-question-form {
        border: 1px solid #ddd;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 4px;
      }
      .t7-ielts-flow-chart-creator .t7-teacher-instructions {
        background-color: #fff3cd;
        border-left: 5px solid #ffc107;
        padding: 10px;
        margin-bottom: 20px;
      }
      .t7-ielts-flow-chart-creator .t7-teacher-instructions h2 {
        color: #856404;
      }
      .t7-ielts-flow-chart-creator .t7-teacher-instructions ul {
        padding-left: 20px;
      }
      .t7-ielts-flow-chart-creator .t7-save-button {
        background-color: #f39c12;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-left: 10px;
      }
      .t7-ielts-flow-chart-creator .t7-save-button:hover {
        background-color: #e67e22;
      }
      .t2-listening-exercise-app {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            background-color: #f5f5f5;
        }

        .t2-listening-exercise-container {
            display: flex;
            gap: 20px;
        }

        .t2-listening-exercise-form-container,
        .t2-listening-exercise-preview-container {
            flex: 1;
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .t2-listening-exercise-app h2 {
            margin-top: 0;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .t2-listening-exercise-form-group {
            margin-bottom: 15px;
        }

        .t2-listening-exercise-app label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .t2-listening-exercise-app input[type="text"],
        .t2-listening-exercise-app input[type="number"],
        .t2-listening-exercise-app textarea,
        .t2-listening-exercise-app select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .t2-listening-exercise-app textarea {
            height: 100px;
            resize: vertical;
        }

        .t2-listening-exercise-app button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .t2-listening-exercise-app button:hover {
            background-color: #45a049;
        }

        .t2-listening-exercise-button-group {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .t2-listening-exercise-save-button {
            background-color: #2196F3;
        }

        .t2-listening-exercise-save-button:hover {
            background-color: #1976D2;
        }

        .t2-listening-exercise-answer-fields {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 10px;
        }

        .t2-listening-exercise-answer-fields textarea {
            flex-grow: 1;
            height: 60px;
        }

        .t2-listening-exercise-instructions-box {
            background-color: #e7f3fe;
            border: 1px solid #b6d4fe;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .t2-listening-exercise-instructions-box h3 {
            margin-top: 0;
            color: #0a58ca;
        }

        .t2-listening-exercise-instructions-box ul {
            margin: 0;
            padding-left: 20px;
        }

        .t2-listening-exercise-correct-answers {
            margin-top: 10px;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
        }

        .t2-listening-exercise-correct-answer-input {
            width: calc(50% - 5px);
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .t2-listening-exercise-correct-answer-label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 5px;
        }

        /* Preview Styles */
        .t2-listening-exercise-preview-container {
            background-color: #fff;
            overflow-x: auto;
        }

        .t2-listening-exercise-instructions {
            font-weight: bold;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .t2-listening-exercise-topic {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .t2-listening-exercise-note-section {
            margin-bottom: 30px;
        }

        .t2-listening-exercise-item-group {
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            white-space: nowrap;
        }

        .t2-listening-exercise-item-label {
            font-weight: bold;
            margin-right: 10px;
            min-width: 80px;
        }

        .t2-listening-exercise-bullet-point {
            display: flex;
            align-items: center;
        }

        .t2-listening-exercise-answer-input {
            width: 60px;
            padding: 5px;
            border: 2px solid #2196F3;
            border-radius: 4px;
            font-size: 14px;
            display: inline-block;
            text-align: center;
            transition: border-color 0.3s, background-color 0.3s;
            margin: 0 5px;
        }

        .t2-listening-exercise-answer-input.correct {
            border-color: #4CAF50;
            background-color: #E8F5E9;
        }

        .t2-listening-exercise-status-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            display: none;
        }

        .t2-listening-exercise-status-message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .t2-listening-exercise-status-message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .t2-listening-exercise-container {
                flex-direction: column;
            }

            .t2-listening-exercise-form-container,
            .t2-listening-exercise-preview-container {
                width: 100%;
            }
        }
        .t1-ielts-creator {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1200px;
            margin: 0 auto;
        }

        .t1-ielts-creator h1, .t1-ielts-creator h2, .t1-ielts-creator h3 {
            color: #333;
        }

        .t1-ielts-creator .t1-form-section, .t1-ielts-creator .t1-question-display, .t1-ielts-creator .t1-instructions-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .t1-ielts-creator .t1-form-group {
            margin-bottom: 15px;
        }

        .t1-ielts-creator label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .t1-ielts-creator input[type="text"], 
        .t1-ielts-creator input[type="number"], 
        .t1-ielts-creator input[type="file"], 
        .t1-ielts-creator select, 
        .t1-ielts-creator textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }

        .t1-ielts-creator button {
            background-color: #007bff;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .t1-ielts-creator button:hover {
            background-color: #0056b3;
        }

        .t1-ielts-creator .t1-question-container {
            margin-top: 20px;
        }

        .t1-ielts-creator .t1-diagram-container {
            margin-bottom: 20px;
        }

        .t1-ielts-creator .t1-diagram-container img {
            max-width: 100%;
            height: auto;
        }

        .t1-ielts-creator .t1-answers-container {
            width: 100%;
        }

        .t1-ielts-creator .t1-answer-grid {
            width: 100%;
            border-collapse: collapse;
        }

        .t1-ielts-creator .t1-answer-grid th,
        .t1-ielts-creator .t1-answer-grid td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: left;
        }

        .t1-ielts-creator .t1-answer-grid th {
            background-color: #f0f0f0;
            font-weight: normal;
        }

        .t1-ielts-creator .t1-answer-input {
            width: 40px;
            height: 30px;
            text-align: center;
            font-size: 16px;
            border: 1px solid #ccc;
        }

        .t1-ielts-creator .t1-instructions {
            margin-bottom: 15px;
        }

        .t1-ielts-creator .t1-instructions-list {
            padding-left: 20px;
        }

        .t1-ielts-creator .t1-instructions-list li {
            margin-bottom: 10px;
        }

        .t1-ielts-creator .t1-save-button {
            margin-top: 20px;
        }

        .t1-ielts-creator .t1-notification {
            padding: 10px;
            margin-top: 10px;
            border-radius: 4px;
        }

        .t1-ielts-creator .t1-notification-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .t1-ielts-creator .t1-notification-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        @media (max-width: 768px) {
            .t1-ielts-creator .t1-answer-grid {
                font-size: 14px;
            }
            
            .t1-ielts-creator .t1-answer-input {
                width: 30px;
                height: 25px;
                font-size: 14px;
            }
        }
        .t3-question-creator {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 20px auto;
            padding: 20px;
            background-color: #f5f5f5;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .t3-question-creator h1, .t3-question-creator h2, .t3-question-creator h3 {
            color: #333;
            margin-bottom: 15px;
        }

        .t3-question-creator .t3-form-group {
            margin-bottom: 20px;
        }

        .t3-question-creator label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .t3-question-creator input[type="text"],
        .t3-question-creator input[type="number"],
        .t3-question-creator textarea,
        .t3-question-creator select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
        }

        .t3-question-creator textarea {
            height: 100px;
        }

        .t3-question-creator button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .t3-question-creator button:hover {
            background-color: #45a049;
        }

        .t3-question-creator .t3-preview {
            margin-top: 40px;
            border-top: 2px solid #ccc;
            padding-top: 20px;
        }

        .t3-question-creator .t3-matching-section {
            display: grid;
            grid-template-columns: 3fr 2fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .t3-question-creator .t3-column-header {
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #ccc;
        }

        .t3-question-creator .t3-matching-content,
        .t3-question-creator .t3-responsibilities-content {
            display: grid;
            gap: 12px;
        }

        .t3-question-creator .t3-person-row {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: 10px;
            align-items: center;
        }

        .t3-question-creator .t3-person-name {
            font-size: 14px;
            color: #333;
            white-space: nowrap;
        }

        .t3-question-creator .t3-answer-box {
            height: 30px;
            border: 1px solid #999;
            border-radius: 4px;
            background-color: #fff;
            display: flex;
            align-items: center;
            padding: 0 10px;
            font-size: 14px;
            min-width: 150px;
        }

        .t3-question-creator .t3-answer-box.t3-dragover {
            background-color: #e8e8e8;
            border: 2px dashed #666;
        }

        .t3-question-creator .t3-responsibility {
            font-size: 14px;
            color: #333;
            background-color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ccc;
            display: inline-block;
            cursor: move;
            user-select: none;
            transition: all 0.2s ease;
        }

        .t3-question-creator .t3-responsibility.t3-dragging {
            opacity: 0.5;
            transform: scale(0.95);
        }

        .t3-question-creator .t3-correct-answer {
            font-size: 12px;
            color: #4CAF50;
            margin-left: 10px;
        }

        .t3-question-creator .t3-guide {
            background-color: #e7f3fe;
            border-left: 5px solid #2196F3;
            padding: 15px;
            margin-bottom: 20px;
        }

        .t3-question-creator .t3-guide h3 {
            color: #2196F3;
            margin-top: 0;
        }

        .t3-question-creator .t3-guide ul {
            padding-left: 20px;
            margin-bottom: 0;
        }

        .t3-question-creator .t3-guide li {
            margin-bottom: 10px;
        }

        .t3-question-creator .t3-save-button {
            background-color: #2196F3;
        }

        .t3-question-creator .t3-save-button:hover {
            background-color: #0b7dda;
        }

        .t3-question-creator .t3-message {
            margin-top: 10px;
            padding: 10px;
            border-radius: 4px;
            font-weight: bold;
        }

        .t3-question-creator .t3-success {
            background-color: #dff0d8;
            color: #3c763d;
        }

        .t3-question-creator .t3-error {
            background-color: #f2dede;
            color: #a94442;
        }
    </style>
</head>
<body>
    <div class="selection-page" id="selectionPage">
        <h1><i class="fas fa-headphones"></i> IELTS Listening Test Creator</h1>
        <p>Select question types to include in your test:</p>
        <div class="question-types">
            <div class="question-type">
                <input type="checkbox" id="oneAnswer" value="One answer">
                <label for="oneAnswer"><i class="fas fa-check-circle"></i> One answer</label>
            </div>
            <div class="question-type">
                <input type="checkbox" id="multipleAnswers" value="More than one answer">
                <label for="multipleAnswers"><i class="fas fa-check-double"></i> More than one answer</label>
            </div>
            <div class="question-type">
                <input type="checkbox" id="matching" value="Matching">
                <label for="matching"><i class="fas fa-link"></i> Matching</label>
            </div>
            <div class="question-type">
                <input type="checkbox" id="labelling" value="Plan/Map/Diagram labelling">
                <label for="labelling"><i class="fas fa-map-marker-alt"></i> Plan/Map/Diagram labelling</label>
            </div>
            <div class="question-type">
                <input type="checkbox" id="noteCompletion" value="Note Completion">
                <label for="noteCompletion"><i class="fas fa-sticky-note"></i> Note Completion</label>
            </div>
            <div class="question-type">
                <input type="checkbox" id="formCompletion" value="Form/Table Completion">
                <label for="formCompletion"><i class="fas fa-table"></i> Form/Table Completion</label>
            </div>
            <div class="question-type">
                <input type="checkbox" id="flowchartCompletion" value="Flow chart Completion">
                <label for="flowchartCompletion"><i class="fas fa-project-diagram"></i> Flow chart Completion</label>
            </div>
        </div>
        <button onclick="startTestCreation()"><i class="fas fa-play"></i> Create Test</button>
    </div>

    <div class="test-creation-page hidden" id="testCreationPage">
        <h1><i class="fas fa-pencil-alt"></i> IELTS Listening Test</h1>
        <div id="testContent"></div>
        <div class="nav-buttons">
            <button onclick="previousPart()"><i class="fas fa-arrow-left"></i> Previous Part</button>
            <button onclick="nextPart()">Next Part <i class="fas fa-arrow-right"></i></button>
        </div>
        <button onclick="saveTest()"><i class="fas fa-save"></i> Save Test</button>
    </div>

    <script>
  // Constants
const MAX_QUESTIONS = 40
const PARTS = 4

// Global variables
let selectedTypes = []
let currentPart = 1
let totalQuestions = 0
const audioFile = null
const audioDuration = 0

// Add test metadata to the test object
let test = {
  title: "",
  description: "",
  part1: [],
  part2: [],
  part3: [],
  part4: [],
}

// Placeholder functions -  These need to be implemented based on your actual requirements.
function fetchQuestionTypes() {
  // Your code to fetch question types from an API or other source.  For now, a sample implementation is provided.
  const questionTypes = [
    "One answer",
    "More than one answer",
    "Matching",
    "Plan/Map/Diagram labelling",
    "Note Completion",
    "Form/Table Completion",
    "Flow chart Completion",
  ]
  const questionTypeContainer = document.getElementById("questionTypes") // Assumes you have a container with this ID in your HTML.
  questionTypes.forEach((type) => {
    const checkbox = document.createElement("input")
    checkbox.type = "checkbox"
    checkbox.value = type
    checkbox.id = type
    const label = document.createElement("label")
    label.htmlFor = type
    label.textContent = type
    questionTypeContainer.appendChild(checkbox)
    questionTypeContainer.appendChild(label)
    questionTypeContainer.appendChild(document.createElement("br"))
  })
}

function saveQuestionSet() {
  // Your code to save the question set.  This is a placeholder.
  console.log("Saving question set...")
  alert("Question set saved!")
}

// Add the saveT2ListeningExercise function
function saveT2ListeningExercise() {
  try {
    const form = document.getElementById("t2ListeningExerciseForm")
    if (!form) {
      throw new Error("Form not found")
    }

    // Get form data
    const instructions = document.getElementById("t2ListeningExerciseInstructions")?.value?.trim()
    const topic = document.getElementById("t2ListeningExerciseTopic")?.value?.trim()
    const questionCount = Number.parseInt(document.getElementById("t2ListeningExerciseQuestionCount")?.value || "0", 10)

    // Validate required fields
    if (!instructions || !topic || questionCount <= 0) {
      const missing = []
      if (!instructions) missing.push("Instructions")
      if (!topic) missing.push("Topic")
      if (questionCount <= 0) missing.push("Number of Questions")

      showMessage(`Please fill in all required fields: ${missing.join(", ")}`, "error")
      return
    }

    // Get questions and answers
    const questions = []
    const correctAnswers = []
    let hasErrors = false

    for (let i = 1; i <= questionCount; i++) {
      const questionText = document.getElementById(`t2ListeningExerciseQuestion${i}`)?.value?.trim()
      const answerInputs = document.querySelectorAll(
        `#t2ListeningExerciseCorrectAnswers${i} .t2-listening-exercise-correct-answer-input`,
      )

      if (!questionText || questionText === "") {
        showMessage(`Question ${i} text is required`, "error")
        hasErrors = true
        continue
      }

      // Validate that question contains [ANSWER] placeholders
      const answerCount = (questionText.match(/\[ANSWER\]/g) || []).length
      if (answerCount === 0) {
        showMessage(`Question ${i} must contain at least one [ANSWER] placeholder`, "error")
        hasErrors = true
        continue
      }

      // Get correct answers
      const answers = Array.from(answerInputs).map((input) => input.value?.trim())
      if (answers.some((answer) => !answer)) {
        showMessage(`All correct answers for Question ${i} must be filled`, "error")
        hasErrors = true
        continue
      }

      if (answers.length !== answerCount) {
        showMessage(`Number of answers doesn't match number of [ANSWER] placeholders in Question ${i}`, "error")
        hasErrors = true
        continue
      }

      questions.push(questionText)
      correctAnswers.push(...answers)
    }

    if (hasErrors) {
      return
    }

    // Create question object
    const questionData = {
      type: "Note Completion",
      content: [instructions, topic, ...questions],
      correctAnswers,
    }

    // Add to test object
    const part = Math.ceil(totalQuestions / 10) || 1
    if (part >= 1 && part <= 4) {
      if (!test[`part${part}`]) {
        test[`part${part}`] = []
      }
      test[`part${part}`].push(questionData)
      totalQuestions += questionCount
    }

    console.log("Saved Note Completion question:", questionData)
    showMessage("Exercise saved successfully!", "success")

    // Reset form
    form.reset()
    updateT2ListeningExercisePreview()
  } catch (error) {
    console.error("Error saving Note Completion exercise:", error)
    showMessage(`Error saving exercise: ${error.message}`, "error")
  }
}

// Update the preview function
function updateT2ListeningExercisePreview() {
  try {
    const previewContent = document.getElementById("t2ListeningExercisePreviewContent")
    if (!previewContent) {
      console.warn("Preview content container not found")
      return
    }

    const instructions = document.getElementById("t2ListeningExerciseInstructions")?.value || ""
    const topic = document.getElementById("t2ListeningExerciseTopic")?.value || ""
    const questionCount = Number.parseInt(document.getElementById("t2ListeningExerciseQuestionCount")?.value || "0", 10)

    let previewHTML = `
      <div class="preview-section">
        <h3>${topic}</h3>
        <p class="instructions">${instructions}</p>
        <div class="questions">
    `

    for (let i = 1; i <= questionCount; i++) {
      const questionText = document.getElementById(`t2ListeningExerciseQuestion${i}`)?.value || ""
      const formattedQuestion = questionText.replace(/\[ANSWER\]/g, "___________")

      previewHTML += `
        <div class="question">
          <p>${i}. ${formattedQuestion}</p>
        </div>
      `
    }

    previewHTML += `
        </div>
      </div>
    `

    previewContent.innerHTML = previewHTML
    console.log("Preview updated successfully")
  } catch (error) {
    console.error("Error updating preview:", error)
  }
}

// Add function to validate test metadata
function validateTestMetadata() {
  if (!test.title) {
    showNotification("Vui lòng nhập tên bộ đề thi", "error")
    return false
  }
  return true
}

// Add function to check minimum questions per part
function validatePartQuestions() {
  // Minimum 2 questions per part is recommended but not required
  const warnings = []
  for (let i = 1; i <= 4; i++) {
    const partQuestions = test[`part${i}`].length
    if (partQuestions === 0) {
      warnings.push(`Part ${i} chưa có câu hỏi nào`)
    }
  }

  if (warnings.length > 0) {
    return confirm(`Cảnh báo:\n${warnings.join("\n")}\n\nBạn có muốn tiếp tục lưu không?`)
  }

  return true
}

// Update the saveTest function
function saveTest() {
  try {
    console.log("Starting to save test...")

    // Validate test metadata first
    if (!validateTestMetadata()) {
      return
    }

    // Check if we have any questions in any part
    let hasQuestions = false
    for (let i = 1; i <= 4; i++) {
      if (test[`part${i}`] && test[`part${i}`].length > 0) {
        hasQuestions = true
        break
      }
    }

    if (!hasQuestions) {
      showNotification("Không tìm thấy câu hỏi nào để lưu. Vui lòng thêm ít nhất một câu hỏi.", "error")
      return
    }

    // Validate part questions
    if (!validatePartQuestions()) {
      return
    }

    console.log("Final saved test:", test)
    showNotification(`Đã lưu thành công bộ đề thi "${test.title}"!`, "success")
  } catch (error) {
    console.error("Error saving test:", error)
    showNotification(`Lỗi khi lưu bài thi: ${error.message}`, "error")
  }
}

// Cập nhật hàm addTestMetadataForm để thêm form vào đầu trang test creation
function addTestMetadataForm() {
  const metadataForm = document.createElement("div")
  metadataForm.className = "test-metadata-form"
  metadataForm.innerHTML = `
    <div class="form-group">
      <label for="testTitle">Tên bộ đề thi:</label>
      <input type="text" id="testTitle" required 
        value="${test.title}"
        onchange="updateTestMetadata('title', this.value)">
    </div>
    <div class="form-group">
      <label for="testDescription">Mô tả (không bắt buộc):</label>
      <textarea id="testDescription" rows="2"
        onchange="updateTestMetadata('description', this.value)">${test.description}</textarea>
    </div>
  `

  // Thêm form vào đầu trang test creation
  const testContent = document.getElementById("testContent")
  if (testContent) {
    testContent.insertBefore(metadataForm, testContent.firstChild)
  } else {
    console.error("Test content container not found")
  }
}

// Update test metadata
function updateTestMetadata(field, value) {
  test[field] = value
}

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("startTestBtn").addEventListener("click", startTestCreation)
  document.getElementById("previousPartBtn").addEventListener("click", previousPart)
  document.getElementById("nextPartBtn").addEventListener("click", nextPart)
  document.getElementById("saveTestBtn").addEventListener("click", saveTest)

  const previewTestBtn = document.createElement("button")
  previewTestBtn.id = "previewTestBtn"
  previewTestBtn.textContent = "Preview Test"
  previewTestBtn.addEventListener("click", previewEntireTest)
  document.getElementById("testCreationPage").appendChild(previewTestBtn)

  const exportTestBtn = document.createElement("button")
  exportTestBtn.id = "exportTestBtn"
  exportTestBtn.textContent = "Export Test"
  exportTestBtn.addEventListener("click", exportTest)
  document.getElementById("testCreationPage").appendChild(exportTestBtn)

  const importTestBtn = document.createElement("button")
  importTestBtn.id = "importTestBtn"
  importTestBtn.textContent = "Import Test"
  importTestBtn.addEventListener("click", importTest)
  document.getElementById("testCreationPage").appendChild(importTestBtn)

  // Thêm nút để lưu bộ câu hỏi
  const saveQuestionSetBtn = document.createElement("button")
  saveQuestionSetBtn.id = "saveQuestionSetBtn"
  saveQuestionSetBtn.textContent = "Lưu bộ câu hỏi"
  saveQuestionSetBtn.addEventListener("click", saveQuestionSet)
  document.getElementById("testCreationPage").appendChild(saveQuestionSetBtn)

  // Gọi hàm để lấy danh sách loại câu hỏi khi trang được tải
  fetchQuestionTypes()

  // Add test metadata form
  addTestMetadataForm()
})

function startTestCreation() {
  selectedTypes = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map((cb) => cb.value)
  if (selectedTypes.length === 0) {
    alert("Please select at least one question type.")
    return
  }
  document.getElementById("selectionPage").classList.add("hidden")
  document.getElementById("testCreationPage").classList.remove("hidden")
  renderTestCreation()
}

// Cập nhật hàm renderTestCreation để gọi addTestMetadataForm
function renderTestCreation() {
  const testContent = document.getElementById("testContent")
  if (!testContent) {
    console.error("Test content container not found")
    return
  }

  testContent.innerHTML = `
    <div class="part-header">
      <h2><i class="fas fa-list-ol"></i> Part ${currentPart}</h2>
      <div class="question-count"><i class="fas fa-question-circle"></i> Total Questions: ${totalQuestions}/40</div>
    </div>
  `

  // Thêm form metadata
  addTestMetadataForm()

  // Create all part containers if they don't exist
  for (let i = 1; i <= 4; i++) {
    if (!document.getElementById(`part${i}`)) {
      const part = document.createElement("div")
      part.className = "part"
      part.id = `part${i}`
      part.style.display = i === currentPart ? "block" : "none"
      testContent.appendChild(part)
    }
  }

  const currentPartElement = document.getElementById(`part${currentPart}`)
  if (currentPartElement) {
    currentPartElement.style.display = "block"
    renderQuestionTypes(currentPartElement)
  }
}

function renderQuestionTypes(container) {
  selectedTypes.forEach((type) => {
    const questionDiv = document.createElement("div")
    questionDiv.className = "question"
    questionDiv.innerHTML = `
            <h3>${getIconForType(type)} ${type}</h3>
            <button onclick="addQuestion('${type}', ${currentPart})"><i class="fas fa-plus"></i> Add ${type} Question</button>
        `
    container.appendChild(questionDiv)
  })
}

function getIconForType(type) {
  const icons = {
    "One answer": '<i class="fas fa-check-circle"></i>',
    "More than one answer": '<i class="fas fa-check-double"></i>',
    Matching: '<i class="fas fa-link"></i>',
    "Plan/Map/Diagram labelling": '<i class="fas fa-map-marker-alt"></i>',
    "Note Completion": '<i class="fas fa-sticky-note"></i>',
    "Form/Table Completion": '<i class="fas fa-table"></i>',
    "Flow chart Completion": '<i class="fas fa-project-diagram"></i>',
  }
  return icons[type] || '<i class="fas fa-question"></i>'
}

function addQuestion(type, partNumber) {
  if (totalQuestions >= 40) {
    alert("You have reached the maximum limit of 40 questions.")
    return
  }

  const part = document.getElementById(`part${partNumber}`)
  const questionNumber = totalQuestions + 1
  const questionDiv = document.createElement("div")
  questionDiv.className = "question"

  // Add the question type header
  const typeHeader = document.createElement("h3")
  typeHeader.textContent = type
  questionDiv.appendChild(typeHeader)

  // Add question number and delete button
  questionDiv.innerHTML += `
    <h4><i class="fas fa-question-circle"></i> Question ${questionNumber}</h4>
    <button class="delete-question" onclick="deleteQuestion(this)"><i class="fas fa-trash"></i></button>
  `

  // Add the appropriate form based on type
  switch (type) {
    case "One answer":
      questionDiv.innerHTML += createOneAnswerForm()
      break
    case "More than one answer":
      questionDiv.innerHTML += createMultipleAnswerForm()
      break
    case "Matching":
      questionDiv.innerHTML += createMatchingForm()
      break
    case "Plan/Map/Diagram labelling":
      questionDiv.innerHTML += createPlanMapDiagramForm()
      break
    case "Note Completion":
      questionDiv.innerHTML += createNoteCompletionForm()
      break
    case "Form/Table Completion":
      questionDiv.innerHTML += createFormTableCompletionForm()
      break
    case "Flow chart Completion":
      questionDiv.innerHTML += createFlowChartCompletionForm()
      break
    default:
      console.error("Unknown question type:", type)
      return
  }

  part.appendChild(questionDiv)
  totalQuestions++
  updateQuestionCount()

  // Initialize form functionality based on type
  switch (type) {
    case "One answer":
      initializeOneAnswerForm(questionDiv)
      break
    case "More than one answer":
      initializeMultipleAnswerForm(questionDiv)
      break
    case "Matching":
      initializeMatchingForm(questionDiv)
      break
    case "Plan/Map/Diagram labelling":
      initializePlanMapDiagram(questionDiv)
      break
    case "Note Completion":
      initializeNoteCompletionForm(questionDiv)
      break
    case "Form/Table Completion":
      initializeFormTableCompletionForm(questionDiv)
      break
    case "Flow chart Completion":
      initializeFlowChartCompletionForm(questionDiv)
      break
  }
}

function deleteQuestion(button) {
  const questionDiv = button.closest(".question")
  questionDiv.remove()
  totalQuestions--
  updateQuestionCount()
  renumberQuestions()
}

function renumberQuestions() {
  const questions = document.querySelectorAll(".question h4")
  questions.forEach((question, index) => {
    question.innerHTML = `<i class="fas fa-question-circle"></i> Question ${index + 1}`
  })
}

function updateQuestionCount() {
  const countElement = document.querySelector(".question-count")
  countElement.innerHTML = `<i class="fas fa-question-circle"></i> Total Questions: ${totalQuestions}/40`
}

function previousPart() {
  if (currentPart > 1) {
    currentPart--
    renderTestCreation()
  }
}

function nextPart() {
  if (currentPart < 4) {
    currentPart++
    renderTestCreation()
  }
}

function processQuestionByType(q, type, questionIndex, part) {
  switch (type) {
    case "One answer": {
      const questionText = q.querySelector("#t3-questionText")?.value?.trim()
      const options =
        q
          .querySelector("#t3-options")
          ?.value?.split("\n")
          .filter((o) => o.trim()) || []
      const correctAnswer = q.querySelector("#t3-correctAnswer")?.value?.trim()

      if (!questionText || options.length === 0 || !correctAnswer) {
        console.warn(`Incomplete data for One answer question ${questionIndex + 1}`)
        return null
      }

      return {
        type,
        content: [questionText, ...options],
        correctAnswers: correctAnswer,
      }
    }

    case "More than one answer": {
      const questionText = q.querySelector("#t4-questionText")?.value?.trim()
      const options =
        q
          .querySelector("#t4-options")
          ?.value?.split("\n")
          .filter((o) => o.trim()) || []
      const answers = q.querySelector("#t4-correctAnswers")?.value?.trim()

      if (!questionText || options.length === 0 || !answers) {
        console.warn(`Incomplete data for More than one answer question ${questionIndex + 1}`)
        return null
      }

      return {
        type,
        content: [questionText, ...options],
        correctAnswers: answers
          .split(",")
          .map((a) => a.trim())
          .filter((a) => a),
      }
    }

    case "Matching": {
      const title = q.querySelector('[id^="t3-questionTitle"]')?.value?.trim()
      const people =
        q
          .querySelector('[id^="t3-people"]')
          ?.value?.split("\n")
          .filter((p) => p.trim()) || []
      const responsibilities =
        q
          .querySelector('[id^="t3-responsibilities"]')
          ?.value?.split("\n")
          .filter((r) => r.trim()) || []
      const answers =
        q
          .querySelector('[id^="t3-correctAnswers"]')
          ?.value?.split("\n")
          .filter((a) => a.trim()) || []

      if (!title || people.length === 0 || responsibilities.length === 0 || answers.length === 0) {
        console.warn(`Incomplete data for Matching question ${questionIndex + 1}`)
        return null
      }

      return {
        type,
        content: [title, ...people, ...responsibilities],
        correctAnswers: answers,
      }
    }

    case "Plan/Map/Diagram labelling": {
      const questionType = q.querySelector("#questionType")?.value
      const instructions = q.querySelector("#instructions")?.value?.trim()
      const imageElement = q.querySelector("img")
      const imageUrl = imageElement ? imageElement.src : ""
      const answers = Array.from(q.querySelectorAll('[id^="answer"]')).map((el) => el.value?.trim() || "")

      // Validate required fields
      if (!questionType || !instructions || !imageUrl || answers.length === 0) {
        console.warn(`Missing required fields for Plan/Map/Diagram question ${questionIndex + 1}`)
        return null
      }

      // Get correct answers based on question type
      let correctAnswers = []
      if (questionType === "map") {
        correctAnswers = answers
          .map((_, index) => {
            const selectedRadio = q.querySelector(`input[name="correctAnswer${index}"]:checked`)
            return selectedRadio ? selectedRadio.value : ""
          })
          .filter((answer) => answer)
      } else {
        correctAnswers = Array.from(q.querySelectorAll('[id^="correctAnswer"]'))
          .map((el) => el.value?.trim())
          .filter((answer) => answer)
      }

      // Validate correct answers
      if (correctAnswers.length !== answers.length) {
        console.warn(`Incorrect number of answers for question ${questionIndex + 1}`)
        return null
      }

      return {
        type,
        content: [questionType, instructions, imageUrl, ...answers],
        correctAnswers,
      }
    }

    case "Note Completion": {
      const instructions = q.querySelector("#t2ListeningExerciseInstructions")?.value?.trim()
      const topic = q.querySelector("#t2ListeningExerciseTopic")?.value?.trim()
      const questions = Array.from(q.querySelectorAll('[id^="t2ListeningExerciseQuestion"]'))
        .map((el) => el.value?.trim())
        .filter((q) => q)
      const answers = Array.from(q.querySelectorAll(".t2-listening-exercise-correct-answer-input"))
        .map((el) => el.value?.trim())
        .filter((a) => a)

      if (!instructions || !topic || questions.length === 0 || answers.length === 0) {
        console.warn(`Incomplete data for Note Completion question ${questionIndex + 1}`)
        return null
      }

      return {
        type,
        content: [instructions, topic, ...questions],
        correctAnswers: answers,
      }
    }

    case "Form/Table Completion": {
      const instruction = q.querySelector("#tableInstruction")?.value?.trim()
      const rows = Array.from(q.querySelectorAll("#fareTable tr")).slice(1) // Skip header row
      const tableData = rows
        .map((row) => {
          const inputs = row.querySelectorAll("input:not(.t6-correct-answer-input)")
          return Array.from(inputs).map((input) => input.value?.trim() || "")
        })
        .filter((row) => row.every((cell) => cell))

      const answers = Array.from(q.querySelectorAll(".t6-correct-answer-input"))
        .map((el) => el.value?.trim())
        .filter((a) => a)

      if (!instruction || tableData.length === 0 || answers.length === 0) {
        console.warn(`Incomplete data for Form/Table Completion question ${questionIndex + 1}`)
        return null
      }

      return {
        type,
        content: [instruction, ...tableData.flat()],
        correctAnswers: answers,
      }
    }

    case "Flow chart Completion": {
      const title = q.querySelector("#flowChartTitle")?.value?.trim()
      const instructions = q.querySelector("#flowChartInstructions")?.value?.trim()
      const flowItems =
        q
          .querySelector("#flowChartItems")
          ?.value?.split("\n")
          .filter((item) => item.trim()) || []
      const options =
        q
          .querySelector("#flowChartOptions")
          ?.value?.split("\n")
          .filter((item) => item.trim()) || []
      const answers = q
        .querySelector("#flowChartAnswers")
        ?.value?.split(",")
        .map((a) => a.trim())
        .filter((a) => a)

      if (!title || !instructions || flowItems.length === 0 || options.length === 0 || answers.length === 0) {
        console.warn(`Incomplete data for Flow chart Completion question ${questionIndex + 1}`)
        return null
      }

      return {
        type,
        content: [title, instructions, ...flowItems, ...options],
        correctAnswers: answers,
      }
    }

    default:
      console.warn(`Unknown question type: ${type}`)
      return null
  }
}

function getCorrectAnswers(questionElement) {
  if (!questionElement) {
    console.warn("Question element is null")
    return []
  }

  // Get the question type from the h3 element that contains the type header
  const typeElement = questionElement.querySelector("h3")
  if (!typeElement) {
    console.warn("Question type element (h3) not found")
    return []
  }

  // Extract only the question type text, removing any icons
  const type = typeElement.textContent.replace(/[^a-zA-Z\s/-]/g, "").trim()

  try {
    switch (type) {
      case "One answer": {
        const element = questionElement.querySelector("#t3-correctAnswer")
        return element?.value || ""
      }
      case "More than one answer": {
        const element = questionElement.querySelector("#t4-correctAnswers")
        return element?.value ? element.value.split(",").map((a) => a.trim()) : []
      }
      case "Matching": {
        const elements = questionElement.querySelectorAll('[id^="t3-correctAnswers"]')
        return Array.from(elements).map((el) => el?.value || "")
      }
      case "Plan/Map/Diagram labelling": {
        const elements = questionElement.querySelectorAll('[id^="correctAnswer"]')
        return Array.from(elements).map((el) => el?.value || "")
      }
      case "Note Completion": {
        const elements = questionElement.querySelectorAll(".t2-listening-exercise-correct-answer-input")
        return Array.from(elements).map((el) => el?.value || "")
      }
      case "Form/Table Completion": {
        const elements = questionElement.querySelectorAll(".t6-correct-answer-input")
        return Array.from(elements).map((el) => el?.value || "")
      }
      case "Flow chart Completion": {
        const element = questionElement.querySelector('[id^="correctAnswers"]')
        return element?.value ? element.value.split(",").map((a) => a.trim()) : []
      }
      default:
        console.warn(`Unknown question type: ${type}`)
        return []
    }
  } catch (error) {
    console.error(`Error processing answers for question type "${type}":`, error)
    return []
  }
}

function createOneAnswerForm() {
  return `
        <div class="t3-question-creator">
            <form class="t3-one-answer-form">
                <div class="t3-form-group">
                    <label for="t3-questionText">Question Text:</label>
                    <input type="text" id="t3-questionText" name="questionText" required>
                </div>
                <div class="t3-form-group">
                    <label for="t3-options">Options (one per line):</label>
                    <textarea id="t3-options" name="options" rows="4" required></textarea>
                </div>
                <div class="t3-form-group">
                    <label for="t3-correctAnswer">Correct Answer:</label>
                    <input type="text" id="t3-correctAnswer" name="correctAnswer" required>
                </div>
                <button type="submit">Create Question</button>
            </form>
            <div class="t3-preview">
                <h2>Question Preview</h2>
                <div id="t3-questionPreview"></div>
            </div>
        </div>
    `
}

function createMultipleAnswerForm() {
  return `
        <div class="t4-container">
            <form id="t4-questionForm">
                <div class="t4-form-group">
                    <label for="t4-questionText">Question Text:</label>
                    <input type="text" id="t4-questionText" name="questionText" required>
                </div>
                <div class="t4-form-group">
                    <label for="t4-options">Options (one per line):</label>
                    <textarea id="t4-options" name="options" rows="4" required></textarea>
                </div>
                <div class="t4-form-group">
                    <label for="t4-correctAnswers">Correct Answers (comma-separated numbers):</label>
                    <input type="text" id="t4-correctAnswers" name="correctAnswers" required>
                </div>
                <button type="submit">Create Question</button>
            </form>
            <div id="t4-previewArea"></div>
        </div>
    `
}

function createMatchingForm() {
  return `
        <div class="t3-question-creator">
            <form id="t3-questionForm">
                <div class="t3-form-group">
                    <label for="t3-numberOfQuestions">Number of Questions:</label>
                    <input type="number" id="t3-numberOfQuestions" name="numberOfQuestions" min="1" max="10" value="1" required>
                </div>
                <div id="t3-questionsContainer"></div>
                <button type="submit">Create Questions</button>
                <button type="button" id="t3-saveButton" class="t3-save-button">Save Questions</button>
            </form>
            <div id="t3-message" class="t3-message" style="display: none;"></div>
            <div class="t3-preview">
                <h2>Questions Preview</h2>
                <div id="t3-questionsPreview"></div>
            </div>
        </div>
    `
}

function createPlanMapDiagramForm() {
  return `
    <div class="t1-ielts-creator">
        <h1>Công cụ tạo câu hỏi IELTS Listening</h1>

        <div class="t1-instructions-section">
            <h2>Hướng dẫn tạo câu hỏi</h2>
            <ol class="t1-instructions-list">
                <li><strong>Chọn loại câu hỏi:</strong> Lựa chọn giữa Ghi nhãn Bản đồ, Sơ đồ Tàu, hoặc Sơ đồ Kỹ thuật.</li>
                <li><strong>Đặt số lượng câu hỏi:</strong> Quyết định số lượng câu hỏi bạn muốn tạo (1-10).</li>
                <li><strong>Viết hướng dẫn:</strong> Cung cấp hướng dẫn rõ ràng cho học viên làm theo.</li>
                <li><strong>Tải lên hình ảnh:</strong> Chọn hình ảnh phù hợp cho câu hỏi (bản đồ, sơ đồ tàu, hoặc sơ đồ kỹ thuật).</li>
                <li><strong>Thêm câu trả lời:</strong>
                    <ul>
                        <li>Đối với Ghi nhãn Bản đồ: Nhập tên địa điểm và chữ cái đúng (A-H).</li>
                        <li>Đối với Sơ đồ Tàu: Nhập tên khu vực và chữ cái hoặc số đúng.</li>
                        <li>Đối với Sơ đồ Kỹ thuật: Chỉ nhập câu trả lời đúng.</li>
                    </ul>
                </li>
                <li><strong>Xem lại và Gửi:</strong> Kiểm tra tất cả các mục nhập và nhấp vào "Thêm câu hỏi" để tạo câu hỏi.</li>
                <li><strong>Lưu câu hỏi:</strong> Sau khi tạo tất cả câu hỏi, nhấp vào "Lưu câu hỏi" để gửi về hệ thống.</li>
            </ol>
        </div>

        <div class="t1-form-section">
            <h2>Tạo câu hỏi mới</h2>
            <form id="questionForm">
                <div class="t1-form-group">
                    <label for="questionType">Loại câu hỏi:</label>
                    <select id="questionType" required>
                        <option value="map">Ghi nhãn Bản đồ</option>
                        <option value="ship">Sơ đồ Tàu</option>
                        <option value="technical">Sơ đồ Kỹ thuật</option>
                    </select>
                </div>
                <div class="t1-form-group">
                    <label for="numQuestions">Số lượng câu hỏi:</label>
                    <input type="number" id="numQuestions" min="1" max="10" value="3" required>
                </div>
                <div class="t1-form-group">
                    <label for="instructions">Hướng dẫn:</label>
                    <textarea id="instructions" rows="3" required></textarea>
                </div>
                <div class="t1-form-group">
                    <label for="imageFile">Tải lên hình ảnh:</label>
                    <input type="file" id="imageFile" accept="image/*" required>
                </div>
                <div id="answerInputs">
                    <!-- Answer inputs will be dynamically added here -->
                </div>
                <button type="submit">Thêm câu hỏi</button>
            </form>
        </div>

        <div id="questionDisplay" class="t1-question-display">
            <h2>Câu hỏi đã tạo</h2>
            <!-- Questions will be dynamically added here -->
        </div>

        <div class="t1-save-button">
            <button id="saveQuestionsBtn">Lưu câu hỏi</button>
        </div>

        <div id="notification" class="t1-notification" style="display: none;"></div>
    </div>
    `
}

function createNoteCompletionForm() {
  return `
    <div class="t2-listening-exercise-app">
        <div class="t2-listening-exercise-container">
            <div class="t2-listening-exercise-form-container">
                <h2>Create Listening Exercise</h2>
                <div class="t2-listening-exercise-instructions-box">
                    <h3>Hướng dẫn đặt câu hỏi:</h3>
                    <ul>
                        <li>Sử dụng [ANSWER] để đánh dấu vị trí cần điền đáp án.</li>
                        <li>Bạn có thể đặt nhiều [ANSWER] trong một câu hỏi.</li>
                        <li>Ví dụ: "The dining table is [ANSWER] shape and [ANSWER] years old."</li>
                        <li>Mỗi [ANSWER] sẽ được chuyển thành một ô trống trong bài tập.</li>
                        <li>Nhập đáp án đúng cho mỗi [ANSWER] trong các ô bên dưới câu hỏi.</li>
                    </ul>
                </div>
                <form id="t2ListeningExerciseForm">
                    <div class="t2-listening-exercise-form-group">
                        <label for="t2ListeningExerciseInstructions">Instructions:</label>
                        <input type="text" id="t2ListeningExerciseInstructions" name="instructions" value="Complete the notes. Write ONE WORD AND/OR A NUMBER in each gap.">
                    </div>
                    <div class="t2-listening-exercise-form-group">
                        <label for="t2ListeningExerciseTopic">Topic:</label>
                        <input type="text" id="t2ListeningExerciseTopic" name="topic" value="Phone call about second-hand furniture">
                    </div>
                    <div class="t2-listening-exercise-form-group">
                        <label for="t2ListeningExerciseQuestionCount">Number of Questions:</label>
                        <input type="number" id="t2ListeningExerciseQuestionCount" name="questionCount" min="1" max="20" value="3">
                    </div>
                    <div id="t2ListeningExerciseQuestionContainer"></div>
                    <div class="t2-listening-exercise-button-group">
                        <button type="button" onclick="updateT2ListeningExercisePreview()">Update Preview</button>
                        <button type="button" class="t2-listening-exercise-save-button" onclick="saveT2ListeningExercise()">Save Exercise</button>
                    </div>
                    <div id="t2ListeningExerciseStatusMessage" class="t2-listening-exercise-status-message"></div>
                </form>
            </div>
            <div class="t2-listening-exercise-preview-container">
                <h2>Preview</h2>
                <div id="t2ListeningExercisePreviewContent">
                    <!-- Preview content will be inserted here -->
                </div>
            </div>
        </div>
    `
}

// Add the saveFormTableCompletion function
function saveFormTableCompletion(container) {
  try {
    // Get form elements
    const instruction = container.querySelector("#tableInstruction")?.value?.trim()
    const table = container.querySelector("#fareTable")

    if (!instruction || !table) {
      showMessage("Instructions and table are required", "error")
      return
    }

    // Get all rows except header
    const rows = Array.from(table.querySelectorAll("tr")).slice(1)
    if (rows.length === 0) {
      showMessage("Please add at least one row to the table", "error")
      return
    }

    // Collect table data and answers
    const tableData = []
    const correctAnswers = []
    let hasErrors = false

    rows.forEach((row, index) => {
      const inputs = row.querySelectorAll("input:not(.t6-correct-answer-input)")
      const correctAnswerInput = row.querySelector(".t6-correct-answer-input")

      // Get row data
      const rowData = Array.from(inputs).map((input) => input.value.trim())

      // Validate row data
      if (rowData.some((cell) => cell === "")) {
        showMessage(`Row ${index + 1} has empty cells`, "error")
        hasErrors = true
        return
      }

      // Get and validate correct answer
      const correctAnswer = correctAnswerInput?.value?.trim()
      if (!correctAnswer) {
        showMessage(`Row ${index + 1} is missing a correct answer`, "error")
        hasErrors = true
        return
      }

      tableData.push(rowData)
      correctAnswers.push(correctAnswer)
    })

    if (hasErrors) {
      return
    }

    // Create question object
    const questionData = {
      type: "Form/Table Completion",
      content: [instruction, ...tableData],
      correctAnswers,
    }

    // Add to test object
    const part = Math.ceil(totalQuestions / 10) || 1
    if (part >= 1 && part <= 4) {
      if (!test[`part${part}`]) {
        test[`part${part}`] = []
      }
      test[`part${part}`].push(questionData)
      totalQuestions += correctAnswers.length
    }

    console.log("Saved Form/Table Completion question:", questionData)
    showMessage("Table saved successfully!", "success")

    // Reset form
    container.querySelector("#tableInstruction").value =
      "Complete the table. Write NO MORE THAN ONE WORD AND/OR A NUMBER for each gap."
    const tbody = table.querySelector("tbody") || table
    while (tbody.rows.length > 1) {
      // Keep header row
      tbody.deleteRow(1)
    }
  } catch (error) {
    console.error("Error saving table:", error)
    showMessage(`Error saving table: ${error.message}`, "error")
  }
}

// Update the createFormTableCompletionForm function to add save button
function createFormTableCompletionForm() {
  return `
    <div class="t6-ielts-listening-creator">
      <div id="tableSection" class="t6-question-container">
        <textarea id="tableInstruction" rows="2">Complete the table. Write NO MORE THAN ONE WORD AND/OR A NUMBER for each gap.</textarea>
        <div class="t6-button-group">
          <button type="button" class="t6-add-row-btn">Add Row</button>
          <button type="button" class="t6-save-btn">Save Table</button>
        </div>
        <table id="fareTable">
          <tr>
            <th>Transport</th>
            <th>Cash Fare</th>
            <th>Card Fare</th>
            <th>Correct Answer</th>
            <th>Actions</th>
          </tr>
        </table>
      </div>
    </div>
  `
}

// Find the initializeFormTableCompletionForm function and replace it with this updated version:

function initializeFormTableCompletionForm(container) {
  const addRowBtn = container.querySelector(".t6-add-row-btn")
  const fareTable = container.querySelector("#fareTable")
  const tableInstruction = container.querySelector("#tableInstruction")

  // Add save button if it doesn't exist
  let saveBtn = container.querySelector(".t6-save-btn")
  if (!saveBtn) {
    saveBtn = document.createElement("button")
    saveBtn.className = "t6-save-btn"
    saveBtn.textContent = "Save Question"
    container.appendChild(saveBtn)
  }

  addRowBtn.addEventListener("click", () => {
    const newRow = fareTable.insertRow()
    newRow.innerHTML = `
      <td><input type="text" class="t6-transport-input" placeholder="Transport type"></td>
      <td><input type="text" class="t6-cash-fare-input" placeholder="Cash fare"></td>
      <td><input type="text" class="t6-card-fare-input" placeholder="Card fare"></td>
      <td><input type="text" class="t6-correct-answer-input" placeholder="Correct answer"></td>
      <td><button class="t6-delete-btn">Delete</button></td>
    `
    setupDeleteButtons(container)
  })

  // Add save functionality
  saveBtn.addEventListener("click", () => {
    try {
      // Validate instruction
      const instruction = tableInstruction.value.trim()
      if (!instruction) {
        showNotification("Please enter table instructions", "error")
        return
      }

      // Get all rows except header
      const rows = Array.from(fareTable.querySelectorAll("tr")).slice(1)
      if (rows.length === 0) {
        showNotification("Please add at least one row to the table", "error")
        return
      }

      // Collect row data and validate
      const tableData = []
      const correctAnswers = []
      let hasError = false
      let errorMessage = ""

      rows.forEach((row, index) => {
        const transport = row.querySelector(".t6-transport-input")?.value.trim()
        const cashFare = row.querySelector(".t6-cash-fare-input")?.value.trim()
        const cardFare = row.querySelector(".t6-card-fare-input")?.value.trim()
        const correctAnswer = row.querySelector(".t6-correct-answer-input")?.value.trim()

        if (!transport || !cashFare || !cardFare) {
          hasError = true
          errorMessage = `Please fill all fields in row ${index + 1}`
          return
        }

        if (!correctAnswer) {
          hasError = true
          errorMessage = `Please provide a correct answer for row ${index + 1}`
          return
        }

        tableData.push([transport, cashFare, cardFare])
        correctAnswers.push(correctAnswer)
      })

      if (hasError) {
        showNotification(errorMessage, "error")
        return
      }

      // Create question object
      const questionData = {
        type: "Form/Table Completion",
        content: [instruction, ...tableData.flat()],
        correctAnswers: correctAnswers,
      }

      // Add to test object
      const part = Math.ceil((totalQuestions + 1) / 10)
      if (part >= 1 && part <= 4) {
        if (!test[`part${part}`]) {
          test[`part${part}`] = []
        }
        test[`part${part}`].push(questionData)
      }

      // Update question count and display
      totalQuestions++
      updateQuestionCount()
      showNotification("Table completion question saved successfully!", "success")

      // Clear form for next question
      tableInstruction.value = "Complete the table. Write NO MORE THAN ONE WORD AND/OR A NUMBER for each gap."
      while (fareTable.rows.length > 1) {
        fareTable.deleteRow(1)
      }

      console.log("Saved question:", questionData)
    } catch (error) {
      console.error("Error saving table completion question:", error)
      showNotification("Error saving question. Please try again.", "error")
    }
  })

  setupDeleteButtons(container)

  // Add initial row if table is empty
  if (fareTable.rows.length <= 1) {
    addRowBtn.click()
  }
}

function createFlowChartCompletionForm() {
  return `
    <div class="t7-ielts-flow-chart-creator">
      <form id="flowChartForm" class="flow-chart-form">
        <div class="form-group">
          <label for="flowChartTitle">Title:</label>
          <input type="text" id="flowChartTitle" name="title" required>
        </div>
        
        <div class="form-group">
          <label for="flowChartInstructions">Instructions:</label>
          <textarea id="flowChartInstructions" name="instructions" required></textarea>
        </div>

        <div class="form-group">
          <label for="flowChartItems">Flow Chart Items (one per line, use ___ for gaps):</label>
          <textarea id="flowChartItems" name="flowItems" required></textarea>
        </div>

        <div class="form-group">
          <label for="flowChartOptions">Options (one per line):</label>
          <textarea id="flowChartOptions" name="options" required></textarea>
        </div>

        <div class="form-group">
          <label for="flowChartAnswers">Correct Answers (comma-separated):</label>
          <input type="text" id="flowChartAnswers" name="correctAnswers" required>
        </div>

        <div class="button-group">
          <button type="submit" class="save-btn">Save Question</button>
          <button type="button" class="preview-btn">Preview</button>
        </div>
      </form>
      <div id="flowChartPreview" class="preview-section"></div>
    </div>
  `
}

// Update the initializeOneAnswerForm function to save the question
function initializeOneAnswerForm(container) {
  const form = container.querySelector(".t3-one-answer-form")
  const preview = container.querySelector("#t3-questionPreview")

  form.addEventListener("submit", (e) => {
    e.preventDefault()
    const questionText = form.querySelector("#t3-questionText").value
    const options = form
      .querySelector("#t3-options")
      .value.split("\n")
      .filter((option) => option.trim() !== "")
    const correctAnswer = form.querySelector("#t3-correctAnswer").value

    // Validate inputs
    if (!questionText || options.length === 0 || !correctAnswer) {
      showNotification("Vui lòng điền đầy đủ thông tin câu hỏi", "error")
      return
    }

    // Create question object
    const questionData = {
      type: "One answer",
      content: [questionText, ...options],
      correctAnswers: correctAnswer,
    }

    // Add to test object
    const part = currentPart
    if (part >= 1 && part <= 4) {
      if (!test[`part${part}`]) {
        test[`part${part}`] = []
      }
      test[`part${part}`].push(questionData)
    }

    preview.innerHTML = `
      <h3>${questionText}</h3>
      ${options
        .map(
          (option, index) => `
        <div>
          <input type="radio" id="option${index}" name="answer" value="${option}">
          <label for="option${index}">${option}</label>
          ${option === correctAnswer ? ' <span class="t3-correct-answer">(Correct)</span>' : ""}
        </div>
      `,
        )
        .join("")}
    `

    showNotification("Câu hỏi đã được lưu thành công!", "success")

    // Reset form for next question
    form.reset()
  })
}

// Update the initializeMultipleAnswerForm function to save the question
function initializeMultipleAnswerForm(container) {
  const form = container.querySelector("#t4-questionForm")
  const previewArea = container.querySelector("#t4-previewArea")

  form.addEventListener("submit", (e) => {
    e.preventDefault()

    const questionText = form.querySelector("#t4-questionText").value
    const options = form
      .querySelector("#t4-options")
      .value.split("\n")
      .filter((option) => option.trim() !== "")
    const correctAnswersInput = form.querySelector("#t4-correctAnswers").value
    const correctAnswers = correctAnswersInput
      .split(",")
      .map((num) => num.trim())
      .filter((num) => num)

    // Validate inputs
    if (!questionText || options.length === 0 || correctAnswers.length === 0) {
      showNotification("Vui lòng điền đầy đủ thông tin câu hỏi", "error")
      return
    }

    // Create question object
    const questionData = {
      type: "More than one answer",
      content: [questionText, ...options],
      correctAnswers: correctAnswers,
    }

    // Add to test object
    const part = currentPart
    if (part >= 1 && part <= 4) {
      if (!test[`part${part}`]) {
        test[`part${part}`] = []
      }
      test[`part${part}`].push(questionData)
    }

    previewArea.innerHTML = `
      <div class="t4-preview">
        <h2>${questionText}</h2>
        ${options
          .map(
            (option, index) => `
            <label>
              <input type="checkbox">
              ${option}
              ${correctAnswers.includes((index + 1).toString()) ? '<span class="t4-correct-answer"> (Correct)</span>' : ""}
            </label>
          `,
          )
          .join("")}
      </div>
    `

    showNotification("Câu hỏi đã được lưu thành công!", "success")

    // Reset form for next question
    form.reset()
  })
}

// Update the saveMatchingQuestions function to save the question
function saveMatchingQuestions(container) {
  const count = Number.parseInt(container.querySelector("#t3-numberOfQuestions").value)

  // Validate that we have at least one question
  if (count <= 0) {
    showNotification("Vui lòng thêm ít nhất một câu hỏi", "error")
    return
  }

  for (let i = 0; i < count; i++) {
    const title = container.querySelector(`#t3-questionTitle${i}`).value
    const people = container
      .querySelector(`#t3-people${i}`)
      .value.split("\n")
      .filter((p) => p.trim() !== "")
    const responsibilities = container
      .querySelector(`#t3-responsibilities${i}`)
      .value.split("\n")
      .filter((r) => r.trim() !== "")
    const correctAnswers = container
      .querySelector(`#t3-correctAnswers${i}`)
      .value.split("\n")
      .filter((a) => a.trim() !== "")

    // Validate inputs
    if (!title || people.length === 0 || responsibilities.length === 0 || correctAnswers.length === 0) {
      showNotification(`Vui lòng điền đầy đủ thông tin cho câu hỏi ${i + 1}`, "error")
      return
    }

    // Create question object
    const questionData = {
      type: "Matching",
      content: [title, ...people, ...responsibilities],
      correctAnswers: correctAnswers,
    }

    // Add to test object
    const part = currentPart
    if (part >= 1 && part <= 4) {
      if (!test[`part${part}`]) {
        test[`part${part}`] = []
      }
      test[`part${part}`].push(questionData)
    }
  }

  showNotification("Câu hỏi đã được lưu thành công!", "success")

  // Reset form for next question
  container.querySelector("#t3-numberOfQuestions").value = "1"
  container.querySelector("#t3-questionsContainer").innerHTML = createQuestionFields(0)
}

// Update the initializeFlowChartCompletionForm function to save the question
function initializeFlowChartCompletionForm(container) {
  if (!container) return

  const form = container.querySelector(".flow-chart-form")
  const preview = container.querySelector("#flowChartPreview")

  if (!form || !preview) return

  form.addEventListener("submit", (e) => {
    e.preventDefault()

    try {
      const title = form.querySelector("#flowChartTitle").value
      const instructions = form.querySelector("#flowChartInstructions").value
      const flowItems = form
        .querySelector("#flowChartItems")
        .value.split("\n")
        .filter((item) => item.trim())
      const options = form
        .querySelector("#flowChartOptions")
        .value.split("\n")
        .filter((item) => item.trim())
      const correctAnswers = form
        .querySelector("#flowChartAnswers")
        .value.split(",")
        .map((item) => item.trim())
        .filter((item) => item)

      // Validate inputs
      if (!title || !instructions || flowItems.length === 0 || options.length === 0 || correctAnswers.length === 0) {
        showNotification("Vui lòng điền đầy đủ thông tin câu hỏi", "error")
        return
      }

      // Create question object
      const questionData = {
        type: "Flow chart Completion",
        content: [title, instructions, ...flowItems, ...options],
        correctAnswers: correctAnswers,
      }

      // Add to test object
      const part = currentPart
      if (part >= 1 && part <= 4) {
        if (!test[`part${part}`]) {
          test[`part${part}`] = []
        }
        test[`part${part}`].push(questionData)
      }

      // Update preview
      updateFlowChartPreview(
        {
          title,
          instructions,
          flowItems,
          options,
          correctAnswers,
        },
        preview,
      )

      showNotification("Câu hỏi đã được lưu thành công!", "success")

      // Reset form for next question
      form.reset()
    } catch (error) {
      console.error("Error saving flow chart question:", error)
      showNotification("Lỗi khi lưu câu hỏi. Vui lòng kiểm tra lại.", "error")
    }
  })

  // Initialize preview button
  const previewBtn = form.querySelector(".preview-btn")
  if (previewBtn) {
    previewBtn.addEventListener("click", () => {
      const formData = {
        title: form.querySelector("#flowChartTitle").value,
        instructions: form.querySelector("#flowChartInstructions").value,
        flowItems: form
          .querySelector("#flowChartItems")
          .value.split("\n")
          .filter((item) => item.trim()),
        options: form
          .querySelector("#flowChartOptions")
          .value.split("\n")
          .filter((item) => item.trim()),
        correctAnswers: form
          .querySelector("#flowChartAnswers")
          .value.split(",")
          .map((item) => item.trim()),
      }
      updateFlowChartPreview(formData, preview)
    })
  }
}

// Update the initializePlanMapDiagram function to save the question
function initializePlanMapDiagram(container) {
  // Initialize container reference first
  const questionContainer = container || document.createElement("div")
  if (!container) {
    console.warn("Container not provided, creating new container")
    questionContainer.className = "t1-ielts-creator"
  }

  // Rest of initialization code...
  if (!questionContainer) {
    console.error("Container not found")
    return
  }

  const questionForm = questionContainer.querySelector("#questionForm")
  if (!questionForm) {
    console.error("Question form not found")
    return
  }

  // Prevent default form submission
  questionForm.addEventListener("submit", (e) => {
    e.preventDefault()

    // Save the question when form is submitted
    saveMapDiagramQuestion(questionContainer)
  })

  const answerInputs = questionContainer.querySelector("#answerInputs")
  const numQuestionsInput = questionContainer.querySelector("#numQuestions")
  const questionTypeSelect = questionContainer.querySelector("#questionType")
  const imageFileInput = questionContainer.querySelector("#imageFile")
  const saveQuestionsBtn = questionContainer.querySelector("#saveQuestionsBtn")
  const notification = questionContainer.querySelector("#notification")

  // Initialize state
  let imageDataUrl = ""

  // Handle image upload
  if (imageFileInput) {
    imageFileInput.addEventListener("change", async (e) => {
      const file = e.target.files[0]
      if (file) {
        try {
          const reader = new FileReader()
          reader.onload = (e) => {
            imageDataUrl = e.target.result
            // Create preview image
            const previewImg = document.createElement("img")
            previewImg.src = imageDataUrl
            previewImg.style.maxWidth = "200px"
            previewImg.style.marginTop = "10px"
            const container = imageFileInput.parentElement
            // Remove old preview if exists
            const oldPreview = container.querySelector("img")
            if (oldPreview) {
              container.removeChild(oldPreview)
            }
            container.appendChild(previewImg)
          }
          reader.readAsDataURL(file)
          console.log("Image file loaded")
        } catch (error) {
          console.error("Error loading image:", error)
          showNotification("Error loading image", "error")
        }
      }
    })
  }

  // Declare updateAnswerInputs here
  function updateAnswerInputs() {
    if (!answerInputs || !numQuestionsInput || !questionTypeSelect) {
      console.warn("Required elements not found for updating answer inputs")
      return
    }

    const numQuestions = Number.parseInt(numQuestionsInput.value, 10)
    const questionType = questionTypeSelect.value

    answerInputs.innerHTML = ""
    for (let i = 0; i < numQuestions; i++) {
      const answerDiv = document.createElement("div")
      answerDiv.className = "t1-form-group"
      answerDiv.innerHTML = `
                <label for="answer${i}">Câu trả lời ${i + 1}:</label>
                <input type="text" id="answer${i}" required>
            `

      if (questionType === "map") {
        answerDiv.innerHTML += `
                    <div class="t1-radio-group">
                        <label>Chọn đáp án đúng:</label>
                        ${["A", "B", "C", "D", "E", "F", "G", "H"]
                          .map(
                            (letter) => `
                            <label>
                                <input type="radio" name="correctAnswer${i}" value="${letter}" required>
                                ${letter}
                            </label>
                        `,
                          )
                          .join("")}
                    </div>
                `
      } else {
        answerDiv.innerHTML += `
                    <label for="correctAnswer${i}">Câu trả lời đúng cho câu ${i + 1}:</label>
                    <input type="text" id="correctAnswer${i}" required>
                `
      }

      answerInputs.appendChild(answerDiv)
    }
  }

  // Update event listeners
  if (numQuestionsInput) {
    numQuestionsInput.addEventListener("change", updateAnswerInputs)
  }

  if (questionTypeSelect) {
    questionTypeSelect.addEventListener("change", updateAnswerInputs)
  }

  // Initialize with default values
  updateAnswerInputs()

  // Handle save button click
  if (saveQuestionsBtn) {
    saveQuestionsBtn.addEventListener("click", () => {
      saveMapDiagramQuestion(questionContainer)
    })
  }

  // Function to save the map/diagram question
  function saveMapDiagramQuestion(questionContainer) {
    try {
      const questionType = questionTypeSelect?.value
      const instructions = questionContainer.querySelector("#instructions")?.value?.trim()
      const numQuestions = Number.parseInt(numQuestionsInput?.value || "0", 10)

      // Validate the form
      if (!validatePlanMapDiagramQuestion(questionForm) || !validateAnswerCount(questionForm, numQuestions)) {
        return
      }

      console.log("Saving form data:", {
        questionType,
        instructions,
        hasImage: !!imageDataUrl,
        numQuestions,
      })

      // Collect answers and validate
      const answers = []
      const correctAnswers = []

      for (let i = 0; i < numQuestions; i++) {
        const answerInput = questionContainer.querySelector(`#answer${i}`)
        const answer = answerInput?.value?.trim() || ""
        answers.push(answer)

        if (questionType === "map") {
          const selectedRadio = questionContainer.querySelector(`input[name="correctAnswer${i}"]:checked`)
          correctAnswers.push(selectedRadio.value)
        } else {
          const correctAnswerInput = questionContainer.querySelector(`#correctAnswer${i}`)
          const correctAnswer = correctAnswerInput?.value?.trim() || ""
          correctAnswers.push(correctAnswer)
        }
      }

      // Create question object
      const questionData = {
        type: "Plan/Map/Diagram labelling",
        content: [questionType, instructions, imageDataUrl, ...answers],
        correctAnswers,
      }

      // Add to test object
      const part = currentPart
      if (part >= 1 && part <= 4) {
        if (!test[`part${part}`]) {
          test[`part${part}`] = []
        }
        test[`part${part}`].push(questionData)
      }

      console.log("Saved question:", questionData)
      showNotification("Câu hỏi đã được lưu thành công!", "success")

      // Reset form
      questionForm.reset()
      imageDataUrl = ""
      // Remove image preview
      const container = imageFileInput.parentElement
      const oldPreview = container.querySelector("img")
      if (oldPreview) {
        container.removeChild(oldPreview)
      }
      updateAnswerInputs()
    } catch (error) {
      console.error("Error saving questions:", error)
      showNotification(`Có lỗi xảy ra: ${error.message}`, "error")
    }
  }
}

function createQuestionFields(index) {
  return `
        <div class="t3-question-fields" data-question="${index}">
            <h3>Question ${index + 1}</h3>
            <div class="t3-form-group">
                <label for="t3-questionTitle${index}">Question Title:</label>
                <input type="text" id="t3-questionTitle${index}" name="questionTitle${index}" required>
            </div>
            <div class="t3-form-group">
                <label for="t3-people${index}">People (one per line):</label>
                <textarea id="t3-people${index}" name="people${index}" required></textarea>
            </div>
            <div class="t3-form-group">
                <label for="t3-responsibilities${index}">Responsibilities (one per line):</label>
                <textarea id="t3-responsibilities${index}" name="responsibilities${index}" required></textarea>
            </div>
            <div class="t3-form-group">
                <label for="t3-correctAnswers${index}">Correct Answers (one per line, in order of people):</label>
                <textarea id="t3-correctAnswers${index}" name="correctAnswers${index}" required></textarea>
            </div>
        </div>
    `
}

function updateMatchingPreview(container) {
  const count = Number.parseInt(container.querySelector("#t3-numberOfQuestions").value)
  let previewHTML = ""

  for (let i = 0; i < count; i++) {
    const title = container.querySelector(`#t3-questionTitle${i}`).value
    const people = container
      .querySelector(`#t3-people${i}`)
      .value.split("\n")
      .filter((p) => p.trim() !== "")
    const responsibilities = container
      .querySelector(`#t3-responsibilities${i}`)
      .value.split("\n")
      .filter((r) => r.trim() !== "")
    const correctAnswers = container
      .querySelector(`#t3-correctAnswers${i}`)
      .value.split("\n")
      .filter((a) => a.trim() !== "")

    previewHTML += `
            <div class="t3-question-preview">
                <h3>Question ${i + 1}</h3>
                <div class="t3-question-title">${title}</div>
                <div class="t3-matching-section">
                    <div>
                        <div class="t3-column-header">People</div>
                        <div class="t3-matching-content">
                            ${people
                              .map(
                                (person, index) => `
                                <div class="t3-person-row">
                                    <div class="t3-person-name">${person}</div>
                                    <div class="t3-answer-box" ondrop="t3Drop(event)" ondragover="t3AllowDrop(event)"></div>
                                    <div class="t3-correct-answer">(${correctAnswers[index] || ""})</div>
                                </div>
                            `,
                              )
                              .join("")}
                        </div>
                    </div>
                    <div>
                        <div class="t3-column-header">Staff Responsibilities</div>
                        <div class="t3-responsibilities-content">
                            ${responsibilities
                              .map(
                                (resp) => `
                                <div class="t3-responsibility" draggable="true" ondragstart="t3Drag(event)">${resp}</div>
                            `,
                              )
                              .join("")}
                        </div>
                    </div>
                </div>
            </div>
        `
  }

  container.querySelector("#t3-questionsPreview").innerHTML = previewHTML
}

function showMessage(message, type = "info") {
  // Try to find existing message element
  let messageElement = document.getElementById("message")

  // Create new message element if it doesn't exist
  if (!messageElement) {
    messageElement = document.createElement("div")
    messageElement.id = "message"
    document.body.appendChild(messageElement)
  }

  // Set message content and style
  messageElement.textContent = message
  messageElement.className = `message message-${type}`
  messageElement.style.display = "block"

  // Auto-hide after 5 seconds
  setTimeout(() => {
    if (messageElement) {
      messageElement.style.display = "none"
    }
  }, 5000)
}

function updateFlowChartPreview(data, previewElement) {
  if (!previewElement) return

  const previewHTML = `
    <div class="flow-chart-preview">
      <h3>${data.title}</h3>
      <p class="instructions">${data.instructions}</p>
      <div class="flow-items">
        ${data.flowItems
          .map(
            (item) => `
          <div class="flow-item">
            ${item.replace("___", '<div class="gap" data-droppable="true"></div>')}
          </div>
        `,
          )
          .join("")}
      </div>
      <div class="options">
        ${data.options
          .map(
            (option) => `
          <div class="option" draggable="true">${option}</div>
        `,
          )
          .join("")}
      </div>
    </div>
  `

  previewElement.innerHTML = previewHTML
  initializeDragAndDrop(previewElement)
}

function initDragAndDrop(container) {
  const options = container.querySelectorAll(".t7-option")
  const gaps = container.querySelectorAll(".t7-gap")

  options.forEach((option) => {
    option.addEventListener("dragstart", dragStart)
    option.addEventListener("dragend", dragEnd)
  })

  gaps.forEach((gap) => {
    gap.addEventListener("dragover", dragOver)
    gap.addEventListener("dragenter", dragEnter)
    gap.addEventListener("dragleave", dragLeave)
    gap.addEventListener("drop", drop)
  })
}

function dragStart(e) {
  e.dataTransfer.setData("text/plain", e.target.innerText)
  e.target.classList.add("dragging")
}

function dragEnd(e) {
  e.target.classList.remove("dragging")
}

function dragOver(e) {
  e.preventDefault()
}

function dragEnter(e) {
  e.preventDefault()
  e.target.classList.add("drag-over")
}

function dragLeave(e) {
  e.target.classList.remove("drag-over")
}

function drop(e) {
  e.preventDefault()
  e.target.classList.remove("drag-over")
  const data = e.dataTransfer.setData("text/plain")
  e.target.textContent = data
}

function previewEntireTest() {
  const previewWindow = window.open("", "Preview", "width=800,height=600")
  let previewContent = "<h1>IELTS Listening Test Preview</h1>"

  for (let i = 1; i <= 4; i++) {
    previewContent += `<h2>Part ${i}</h2>`
    const part = document.getElementById(`part${i}`)
    const questions = part.querySelectorAll(".question")
    questions.forEach((question, index) => {
      previewContent += `<div class="preview-question">
                <h3>Question ${index + 1}</h3>
                ${question.innerHTML}
            </div>`
    })
  }

  previewWindow.document.body.innerHTML = previewContent
}

function exportTest() {
  const testData = JSON.stringify(test, null, 2)
  const blob = new Blob([testData], { type: "application/json" })
  const url = URL.createObjectURL(blob)
  const a = document.createElement("a")
  a.href = url
  a.download = "ielts_listening_test.json"
  document.body.appendChild(a)
  a.click()
  document.body.removeChild(a)
  URL.revokeObjectURL(url)
}

function importTest() {
  const input = document.createElement("input")
  input.type = "file"
  input.accept = "application/json"
  input.onchange = (e) => {
    const file = e.target.files[0]
    const reader = new FileReader()
    reader.onload = (event) => {
      try {
        const importedTest = JSON.parse(event.target.result)
        test = importedTest
        renderImportedTest()
      } catch (error) {
        console.error("Error parsing imported test:", error)
        alert("Error importing test. Please make sure the file is a valid JSON.")
      }
    }
    reader.readAsText(file)
  }
  input.click()
}

function renderImportedTest() {
  document.getElementById("selectionPage").classList.add("hidden")
  document.getElementById("testCreationPage").classList.remove("hidden")
  totalQuestions = 0

  for (let i = 1; i <= 4; i++) {
    const part = document.getElementById(`part${i}`)
    part.innerHTML = ""
    test[`part${i}`].forEach((question) => {
      const questionDiv = document.createElement("div")
      questionDiv.className = "question"
      questionDiv.innerHTML = `
                <h4><i class="fas fa-question-circle"></i> Question ${totalQuestions + 1}</h4>
                <h3>${question.type}</h3>
                <button class="delete-question" onclick="deleteQuestion(this)"><i class="fas fa-trash"></i></button>
                ${renderImportedQuestion(question)}
            `
      part.appendChild(questionDiv)
      totalQuestions++
    })
  }

  updateQuestionCount()
  currentPart = 1
  renderTestCreation()
}

function renderImportedQuestion(question) {
  switch (question.type) {
    case "One answer":
      return renderImportedOneAnswer(question)
    case "More than one answer":
      return renderImportedMultipleAnswer(question)
    case "Matching":
      return renderImportedMatching(question)
    case "Plan/Map/Diagram labelling":
      return renderImportedPlanMapDiagram(question)
    case "Note Completion":
      return renderImportedNoteCompletion(question)
    case "Form/Table Completion":
      return renderImportedFormTableCompletion(question)
    case "Flow chart Completion":
      return renderImportedFlowChartCompletion(question)
    default:
      return "<p>Unsupported question type</p>"
  }
}

function renderImportedOneAnswer(question) {
  return `
        <div class="t3-question-creator">
            <form class="t3-one-answer-form">
                <div class="t3-form-group">
                    <label for="t3-questionText">Question Text:</label>
                    <input type="text" id="t3-questionText" name="questionText" value="${question.content[0]}" required>
                </div>
                <div class="t3-form-group">
                    <label for="t3-options">Options (one per line):</label>
                    <textarea id="t3-options" name="options" rows="4" required>${question.content.slice(1).join("\n")}</textarea>
                </div>
                <div class="t3-form-group">
                    <label for="t3-correctAnswer">Correct Answer:</label>
                    <input type="text" id="t3-correctAnswer" name="correctAnswer" value="${question.correctAnswers}" required>
                </div>
            </form>
        </div>
    `
}

function renderImportedMultipleAnswer(question) {
  return `
        <div class="t4-container">
            <form id="t4-questionForm">
                <div class="t4-form-group">
                    <label for="t4-questionText">Question Text:</label>
                    <input type="text" id="t4-questionText" name="questionText" value="${question.content[0]}" required>
                </div>
                <div class="t4-form-group">
                    <label for="t4-options">Options (one per line):</label>
                    <textarea id="t4-options" name="options" rows="4" required>${question.content.slice(1).join("\n")}</textarea>
                </div>
                <div class="t4-form-group">
                    <label for="t4-correctAnswers">Correct Answers (comma-separated numbers):</label>
                    <input type="text" id="t4-correctAnswers" name="correctAnswers" value="${question.correctAnswers.join(", ")}" required>
                </div>
            </form>
        </div>
    `
}

function renderImportedMatching(question) {
  return `
        <div class="t3-question-creator">
            <form id="t3-questionForm">
                <div class="t3-form-group">
                    <label for="t3-questionTitle">Question Title:</label>
                    <input type="text" id="t3-questionTitle" name="questionTitle" value="${question.content[0]}" required>
                </div>
                <div class="t3-form-group">
                    <label for="t3-people">People (one per line):</label>
                    <textarea id="t3-people" name="people" required>${question.content[1]}</textarea>
                </div>
                <div class="t3-form-group">
                    <label for="t3-responsibilities">Responsibilities (one per line):</label>
                    <textarea id="t3-responsibilities" name="responsibilities" required>${question.content[2]}</textarea>
                </div>
                <div class="t3-form-group">
                    <label for="t3-correctAnswers">Correct Answers (one per line, in order of people):</label>
                    <textarea id="t3-correctAnswers" name="correctAnswers" required>${question.correctAnswers.join("\n")}</textarea>
                </div>
            </form>
        </div>
    `
}

function renderImportedPlanMapDiagram(question) {
  return `
        <div class="t1-ielts-creator">
            <form id="questionForm">
                <div class="t1-form-group">
                    <label for="questionType">Loại câu hỏi:</label>
                    <select id="questionType" required>
                        <option value="map" ${question.content[0] === "map" ? "selected" : ""}>Ghi nhãn Bản đồ</option>
                        <option value="ship" ${question.content[0] === "ship" ? "selected" : ""}>Sơ đồ Tàu</option>
                        <option value="technical" ${question.content[0] === "technical" ? "selected" : ""}>Sơ đồ Kỹ thuật</option>
                    </select>
                </div>
                <div class="t1-form-group">
                    <label for="instructions">Hướng dẫn:</label>
                    <textarea id="instructions" rows="3" required>${question.content[1]}</textarea>
                </div>
                <div class="t1-form-group">
                    <label for="imageFile">Hình ảnh đã tải lên:</label>
                    <img src="${question.content[2]}" alt="Uploaded image" style="max-width: 200px;">
                </div>
                <div id="answerInputs">
                    ${question.content
                      .slice(3)
                      .map(
                        (answer, index) => `
                        <div class="t1-form-group">
                            <label for="answer${index}">Câu trả lời ${index + 1}:</label>
                            <input type="text" id="answer${index}" value="${answer}" required>
                            <label for="correctAnswer${index}">Câu trả lời đúng cho câu ${index + 1}:</label>
                            <input type="text" id="correctAnswer${index}" value="${question.correctAnswers[index]}" required>
                        </div>
                    `,
                      )
                      .join("")}
                </div>
            </form>
        </div>
    `
}

function renderImportedNoteCompletion(question) {
  return `
        <div class="t2-listening-exercise-app">
            <div class="t2-listening-exercise-container">
                <div class="t2-listening-exercise-form-container">
                    <form id="t2ListeningExerciseForm">
                        <div class="t2-listening-exercise-form-group">
                            <label for="t2ListeningExerciseInstructions">Instructions:</label>
                            <input type="text" id="t2ListeningExerciseInstructions" name="instructions" value="${question.content[0]}">
                        </div>
                        <div class="t2-listening-exercise-form-group">
                            <label for="t2ListeningExerciseTopic">Topic:</label>
                            <input type="text" id="t2ListeningExerciseTopic" name="topic" value="${question.content[1]}">
                        </div>
                        <div id="t2ListeningExerciseQuestionContainer">
                            ${question.content
                              .slice(2)
                              .map(
                                (q, index) => `
                                <div class="t2-listening-exercise-form-group">
                                    <label for="t2ListeningExerciseQuestion${index + 1}">Question ${index + 1}:</label>
                                    <div class="t2-listening-exercise-answer-fields">
                                        <textarea id="t2ListeningExerciseQuestion${index + 1}" name="question${index + 1}">${q}</textarea>
                                    </div>
                                    <div class="t2-listening-exercise-correct-answers" id="t2ListeningExerciseCorrectAnswers${index + 1}">
                                        <span class="t2-listening-exercise-correct-answer-label">Correct Answer:</span>
                                        <input type="text" class="t2-listening-exercise-correct-answer-input" value="${question.correctAnswers[index]}">
                                    </div>
                                </div>
                            `,
                              )
                              .join("")}
                        </div>
                    </form>
                </div>
            </div>
        </div>
    `
}

function renderImportedFormTableCompletion(question) {
  return `
        <div class="t6-ielts-listening-creator">
            <div id="tableSection" class="t6-question-container">
                <textarea id="tableInstruction" rows="2">${question.content[0]}</textarea>
                <table id="fareTable">
                    <tr>
                        <th>Transport</th>
                        <th>Cash Fare</th>
                        <th>Card Fare</th>
                        <th>Correct Answer</th>
                        <th>Actions</th>
                    </tr>
                    ${question.content
                      .slice(1)
                      .map(
                        (row, index) => `
                        <tr>
                            <td><input type="text" value="${row[0]}"></td>
                            <td><input type="text" value="${row[1]}"></td>
                            <td><input type="text" value="${row[2]}"></td>
                            <td><input type="text" class="t6-correct-answer-input" value="${question.correctAnswers[index]}"></td>
                            <td><button class="t6-delete-btn">Delete</button></td>
                        </tr>
                    `,
                      )
                      .join("")}
                </table>
            </div>
        </div>
    `
}

function renderImportedFlowChartCompletion(question) {
  return `
        <div class="t7-ielts-flow-chart-creator">
            <form id="teacherForm">
                <label for="title">Title:</label>
                <input type="text" id="title" name="title" value="${question.content[0]}" required>

                <label for="instructions">Instructions:</label>
                <textarea id="instructions" name="instructions" required>${question.content[1]}</textarea>

                <div id="questionForms">
                    <div class="t7-question-form">
                        <h3>Question 1</h3>
                        <label for="flowItems1">Flow Chart Items (one per line, use ___ for gaps):</label>
                        <textarea id="flowItems1" name="flowItems1" required>${question.content[2]}</textarea>
                        <label for="options1">Options (one per line):</label>
                        <textarea id="options1" name="options1" required>${question.content[3]}</textarea>
                        <label for="correctAnswers1">Correct Answers (comma-separated):</label>
                        <input type="text" id="correctAnswers1" name="correctAnswers1" value="${question.correctAnswers.join(", ")}" required>
                    </div>
                </div>
            </form>
        </div>
    `
}

function setupDeleteButtons(container) {
  const deleteButtons = container.querySelectorAll(".t6-delete-btn")
  deleteButtons.forEach((button) => {
    button.addEventListener("click", function () {
      this.closest("tr").remove()
    })
  })
}

function updateT2ListeningExerciseCorrectAnswerFields(questionNumber) {
  const questionText = document.getElementById(`t2ListeningExerciseQuestion${questionNumber}`).value
  const correctAnswersContainer = document.getElementById(`t2ListeningExerciseCorrectAnswers${questionNumber}`)
  const answerCount = (questionText.match(/\[ANSWER\]/g) || []).length

  correctAnswersContainer.innerHTML = `
        <span class="t2-listening-exercise-correct-answer-label">Correct Answers:</span>
    `

  for (let i = 0; i < answerCount; i++) {
    correctAnswersContainer.innerHTML += `
            <input type="text" class="t2-listening-exercise-correct-answer-input" placeholder="Answer ${i + 1}">
        `
  }
}

// Initialize drag and drop functionality
function initializeDragAndDrop(container) {
  const options = container.querySelectorAll(".option")
  const gaps = container.querySelectorAll(".gap")

  options.forEach((option) => {
    option.addEventListener("dragstart", dragStartHandler)
    option.addEventListener("dragend", dragEndHandler)
  })

  gaps.forEach((gap) => {
    gap.addEventListener("dragover", dragOverHandler)
    gap.addEventListener("dragenter", dragEnterHandler)
    gap.addEventListener("dragleave", dragLeaveHandler)
    gap.addEventListener("drop", dropHandler)
  })
}

function dragStartHandler(event) {
  event.dataTransfer.setData("text", event.target.textContent)
}

function dragOverHandler(event) {
  event.preventDefault()
}

function dragEnterHandler(event) {
  event.preventDefault()
  event.target.classList.add("drag-over")
}

function dragLeaveHandler(event) {
  event.target.classList.remove("drag-over")
}

function dropHandler(event) {
  event.preventDefault()
  const data = event.dataTransfer.getData("text")
  event.target.textContent = data
  event.target.classList.remove("drag-over")
}

// showNotification function
function showNotification(message, type = "info") {
  let notification = document.getElementById("notification")

  // Create notification element if it doesn't exist
  if (!notification) {
    notification = document.createElement("div")
    notification.id = "notification"
    document.body.appendChild(notification)
  }

  // Set message content and style
  notification.textContent = message
  notification.className = `notification notification-${type}`
  notification.style.display = "block"

  // Add styles
  Object.assign(notification.style, {
    position: "fixed",
    top: "20px",
    right: "20px",
    padding: "10px",
    margin: "10px 0",
    borderRadius: "4px",
    zIndex: "9999",
    maxWidth: "300px",
    boxShadow: "0 2px 4px rgba(0,0,0,0.2)",
  })

  if (type === "error") {
    Object.assign(notification.style, {
      backgroundColor: "#fee2e2",
      color: "#dc2626",
      border: "1px solid #dc2626",
    })
  } else if (type === "success") {
    Object.assign(notification.style, {
      backgroundColor: "#dcfce7",
      color: "#16a34a",
      border: "1px solid #16a34a",
    })
  }

  // Auto-hide after 5 seconds
  setTimeout(() => {
    if (notification) {
      notification.style.display = "none"
    }
  }, 5000)
}

function validatePlanMapDiagramQuestion(questionElement) {
  if (!questionElement) {
    console.warn("Question element is null")
    return false
  }

  // Get the selected question type
  const questionType = questionElement.querySelector("#questionType")?.value
  const instructions = questionElement.querySelector("#instructions")?.value?.trim()
  const imageElement = questionElement.querySelector("img")
  const imageFile = questionElement.querySelector("#imageFile")?.files[0]
  const imageDataUrl = imageElement?.src

  // Log validation state
  console.log("Validating Plan/Map/Diagram question:", {
    questionType,
    hasInstructions: !!instructions,
    hasImage: !!(imageElement || imageFile),
    hasImageData: !!imageDataUrl,
  })

  // Check basic required fields
  if (!questionType) {
    showNotification("Vui lòng chọn loại câu hỏi", "error")
    return false
  }

  if (!instructions) {
    showNotification("Vui lòng nhập hướng dẫn", "error")
    return false
  }

  // Check for image
  if (!imageDataUrl && !imageFile) {
    showNotification("Vui lòng tải lên hình ảnh", "error")
    return false
  }

  // Get number of questions
  const numQuestions = Number.parseInt(questionElement.querySelector("#numQuestions")?.value || "0", 10)
  if (numQuestions <= 0) {
    showNotification("Vui lòng nhập số lượng câu hỏi hợp lệ", "error")
    return false
  }

  // Validate answers based on selected type
  let hasValidAnswers = true
  for (let i = 0; i < numQuestions; i++) {
    const answer = questionElement.querySelector(`#answer${i}`)?.value?.trim()
    if (!answer) {
      showNotification(`Vui lòng nhập câu trả lời cho câu ${i + 1}`, "error")
      hasValidAnswers = false
      break
    }

    if (questionType === "map") {
      const radioButtons = questionElement.querySelectorAll(`input[name="correctAnswer${i}"]`)
      const selectedRadio = Array.from(radioButtons).find((radio) => radio.checked)

      if (!selectedRadio) {
        showNotification(`Vui lòng chọn đáp án đúng cho câu ${i + 1}`, "error")
        hasValidAnswers = false
        break
      }

      // Validate that the selected answer is valid (A-H)
      const validAnswers = ["A", "B", "C", "D", "E", "F", "G", "H"]
      if (!validAnswers.includes(selectedRadio.value)) {
        showNotification(`Đáp án không hợp lệ cho câu ${i + 1}`, "error")
        hasValidAnswers = false
        break
      }
    } else {
      const correctAnswer = questionElement.querySelector(`#correctAnswer${i}`)?.value?.trim()
      if (!correctAnswer) {
        showNotification(`Vui lòng nhập đáp án đúng cho câu ${i + 1}`, "error")
        hasValidAnswers = false
        break
      }
    }
  }

  return hasValidAnswers
}

function validateAnswerCount(questionElement, numQuestions) {
  const answers = Array.from(questionElement.querySelectorAll('[id^="answer"]'))
    .map((el) => el.value?.trim())
    .filter(Boolean)

  const correctAnswers = Array.from(questionElement.querySelectorAll('[name^="correctAnswer"]:checked'))
    .map((el) => el.value)
    .filter(Boolean)

  if (answers.length !== numQuestions) {
    showNotification(`Số lượng câu trả lời (${answers.length}) không khớp với số câu hỏi (${numQuestions})`, "error")
    return false
  }

  if (correctAnswers.length !== numQuestions) {
    showNotification(
      `Số lượng đáp án đúng (${correctAnswers.length}) không khớp với số câu hỏi (${numQuestions})`,
      "error",
    )
    return false
  }

  return true
}

// Thêm CSS cho form metadata
const metadataStyles = `
  .test-metadata-form {
    margin-bottom: 20px;
    padding: 15px;
    background-color: #f8f9fa;
    border: 1px solid #ddd;
    border-radius: 4px;
  }
  
  .test-metadata-form .form-group {
    margin-bottom: 15px;
  }
  
  .test-metadata-form label {
    display: block;
    margin-bottom: 5px;
    font-weight: bold;
    color: #333;
  }
  
  .test-metadata-form input[type="text"],
  .test-metadata-form textarea {
    width: 100%;
    padding: 8px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 14px;
  }

  .test-metadata-form input[type="text"]:focus,
  .test-metadata-form textarea:focus {
    outline: none;
    border-color: #4a90e2;
    box-shadow: 0 0 0 2px rgba(74, 144, 226, 0.2);
  }
`

// Thêm styles vào document
const styleElement = document.createElement("style")
styleElement.textContent = metadataStyles
document.head.appendChild(styleElement)

function validateQuestion(questionData, type) {
  if (!questionData) return false

  switch (type) {
    case "Plan/Map/Diagram labelling":
      return (
        questionData.content &&
        questionData.content.length >= 4 && // type, instructions, image, and at least one answer
        questionData.correctAnswers &&
        questionData.correctAnswers.length > 0 &&
        questionData.correctAnswers.length === questionData.content.length - 3 // subtract type, instructions, and image
      )
    // Add validation for other question types as needed
    default:
      return true
  }
}

// Declare initializeMatchingForm, initializeNoteCompletionForm, and dragEndHandler
function initializeMatchingForm(container) {
  const form = container.querySelector("#t3-questionForm")
  const questionsContainer = container.querySelector("#t3-questionsContainer")
  const numberOfQuestionsInput = container.querySelector("#t3-numberOfQuestions")
  const saveButton = container.querySelector("#t3-saveButton")
  const questionsPreview = container.querySelector("#t3-questionsPreview")

  // Initialize with one question field
  questionsContainer.innerHTML = createQuestionFields(0)

  // Update question fields when number of questions changes
  numberOfQuestionsInput.addEventListener("change", () => {
    const count = Number.parseInt(numberOfQuestionsInput.value)
    let fieldsHTML = ""
    for (let i = 0; i < count; i++) {
      fieldsHTML += createQuestionFields(i)
    }
    questionsContainer.innerHTML = fieldsHTML
  })

  // Save questions
  saveButton.addEventListener("click", () => {
    saveMatchingQuestions(container)
  })

  // Update preview
  form.addEventListener("input", () => {
    updateMatchingPreview(container)
  })
}

function initializeNoteCompletionForm(container) {
  const questionCountInput = container.querySelector("#t2ListeningExerciseQuestionCount")
  const questionContainer = container.querySelector("#t2ListeningExerciseQuestionContainer")

  // Function to update question fields
  function updateQuestionFields() {
    const questionCount = Number.parseInt(questionCountInput.value, 10)
    let questionFieldsHTML = ""

    for (let i = 1; i <= questionCount; i++) {
      questionFieldsHTML += `
        <div class="t2-listening-exercise-form-group">
          <label for="t2ListeningExerciseQuestion${i}">Question ${i}:</label>
          <div class="t2-listening-exercise-answer-fields">
            <textarea id="t2ListeningExerciseQuestion${i}" name="question${i}" oninput="updateT2ListeningExerciseCorrectAnswerFields(${i})"></textarea>
          </div>
          <div class="t2-listening-exercise-correct-answers" id="t2ListeningExerciseCorrectAnswers${i}">
            <span class="t2-listening-exercise-correct-answer-label">Correct Answers:</span>
            <input type="text" class="t2-listening-exercise-correct-answer-input" placeholder="Answer 1">
          </div>
        </div>
      `
    }

    questionContainer.innerHTML = questionFieldsHTML
  }

  // Initial call to create question fields
  updateQuestionFields()

  // Event listener for question count change
  questionCountInput.addEventListener("change", updateQuestionFields)
}

function dragEndHandler(event) {
  event.target.classList.remove("dragging")
}


    </script>
        </body></html>

